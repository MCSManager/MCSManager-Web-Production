(()=>{"use strict";var e={3165:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(6296);r.initVersionManager();const s=r.getVersion();console.log(`______  _______________________  ___                                         \n___   |/  /_  ____/_  ___/__   |/  /_____ _____________ _______ _____________\n__  /|_/ /_  /    _____ \\__  /|_/ /_  __  /_  __ \\  __  /_  __  /  _ \\_  ___/\n_  /  / / / /___  ____/ /_  /  / / / /_/ /_  / / / /_/ /_  /_/ //  __/  /    \n/_/  /_/  \\____/  /____/ /_/  /_/  \\__,_/ /_/ /_/\\__,_/ _\\__, / \\___//_/     \n                                                        /____/             \n + Released under the AGPL-3.0 License\n + Copyright 2022 Suwings\n + Version ${s}\n`),i(n(7147)).default.existsSync("public")||(console.log("Unable to start, this project is used by the MCSManager development environment and cannot be run directly."),console.log("Please go to https://mcsmanager.com/ for the latest installation method."),console.log('If you are running in development mode, create "public" directory and place the frontend static files before rerunning.'),console.log(""),console.log("无法启动，此项目是 MCSManager 开发人员所用项目，普通用户不可直接运行。"),console.log("请前往 https://mcsmanager.com/ 了解最新的安装方式。"),console.log("如果您要以开发模式运行，请创建 public 目录并放置前端静态文件再重新运行。"),process.exit(0));const o=i(n(1406)),u=n(5828),a=i(n(1017)),l=i(n(5004)),d=i(n(9511)),c=i(n(8097)),f=i(n(3685)),g=n(8264),y=n(8145),p=__dirname,m=n(6547);m.initSystemConfig();const _=new o.default;var h,v;_.on("error",(e=>{})),_.use(l.default({multipart:!0,parsedMethods:["POST","PUT","DELETE","GET"]})),_.keys=[u.v4()],_.use(d.default({key:u.v4(),maxAge:864e5,overwrite:!0,httpOnly:!0,signed:!0,rolling:!1,renew:!1,secure:!1},_)),_.use((async(e,t)=>{g.logger.info(`${e.ip} ${e.method} - ${e.URL.href}`),await t()})),_.use(y.middleware),_.use(c.default(a.default.join(p,"public"))),n(4069).index(_),process.on("uncaughtException",(function(e){g.logger.error("ERROR (uncaughtException):",e)})),process.on("unhandledRejection",((e,t)=>{g.logger.error("ERROR (unhandledRejection):",e,t)})),h=m.systemConfig.httpPort,v=m.systemConfig.httpIp,f.default.createServer(_.callback()).listen(h,v),g.logger.info("================================"),g.logger.info("控制面板端已启动"),g.logger.info("项目参考: https://github.com/mcsmanager"),g.logger.info(`访问地址: http://${v||"localhost"}:${h}/`),g.logger.info(`软件公网访问需开放端口 ${h} 与守护进程端口`),g.logger.info("关闭此程序请使用 Ctrl+C 快捷键"),g.logger.info("================================")},299:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class n{static set(e,t){n.map.set(e,t)}static get(e,t){return n.map.has(e)?n.map.get(e):t}static del(e){return n.map.delete(e)}}t.default=n,n.map=new Map},5739:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.listenMap=new Map}requestForward(e,t){if(this.listenMap.has(t)){const n=this.listenMap.get(t);for(const t of n)if(t.id===e.id)throw new Error(`此 Socket ${e.id} 已经存在于指定实例监听表中`);n.push(e)}else this.listenMap.set(t,[e])}cannelForward(e,t){if(!this.listenMap.has(t))throw new Error(`指定 ${t} 并不存在于监听表中`);const n=this.listenMap.get(t);n.forEach(((t,i)=>{t.id===e.id&&n.splice(i,1)}))}forward(e,t){this.listenMap.get(e).forEach((e=>{e&&e.connected&&e.emit("instance/stdout",t)}))}forwardViaCallback(e,t){this.listenMap.has(e)&&this.listenMap.get(e).forEach((e=>{e&&e.connected&&t(e)}))}hasListenInstance(e){return this.listenMap.has(e)&&this.listenMap.get(e).length>0}}},9728:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.QueryWrapper=t.LocalFileSource=t.MySqlSource=t.QueryMapWrapper=void 0,t.QueryMapWrapper=class{constructor(e){this.map=e}select(e){const t=[];return this.map.forEach((n=>{e(n)&&t.push(n)})),t}page(e,t=1,n=10){const i=(t-1)*n,r=i+n;let s=e.length,o=0;for(;s>0;)s-=n,o++;return{page:t,pageSize:n,maxPage:o,data:e.slice(i,r)}}},t.MySqlSource=class{},t.LocalFileSource=class{constructor(e){this.data=e}selectPage(e,t=1,n=10){const i=[];return this.data.forEach((t=>{for(const n in e){const i=t[n],r=e[n];if("%"==r[0]){if(!i.includes(r.slice(1,r.length-1)))return!1}else if(r!==i)return!1}i.push(t)})),this.page(i,t,n)}page(e,t=1,n=10){const i=(t-1)*n,r=i+n;let s=e.length,o=0;for(;s>0;)s-=n,o++;return{page:t,pageSize:n,maxPage:o,total:e.length,data:e.slice(i,r)}}select(e){return null}update(e,t){}delete(e){}insert(e){}},t.QueryWrapper=class{constructor(e){this.dataSource=e}selectPage(e,t=1,n=10){return this.dataSource.selectPage(e,t,n)}}},9857:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.systemInfo=void 0;const r=i(n(2037)),s=i(n(7411)),o=i(n(7147)),u={type:r.default.type(),hostname:r.default.hostname(),platform:r.default.platform(),release:r.default.release(),uptime:r.default.uptime(),cwd:process.cwd(),loadavg:r.default.loadavg(),freemem:0,cpuUsage:0,memUsage:0,totalmem:0,processCpu:0,processMem:0};function a(){u.freemem=r.default.freemem(),u.totalmem=r.default.totalmem(),u.memUsage=(r.default.totalmem()-r.default.freemem())/r.default.totalmem(),s.default.cpuUsage((e=>u.cpuUsage=e))}setInterval((()=>"linux"===r.default.platform()?function(){var e;try{const t=o.default.readFileSync("/proc/meminfo",{encoding:"utf-8"}).split("\n"),n={};t.forEach((e=>{const t=e.split(":");if(2===t.length){const e=t[0].replace(/ /gim,"").replace(/\t/gim,"").trim().toLowerCase();let i=t[1].replace(/ /gim,"").replace(/\t/gim,"").trim().toLowerCase();i=i.replace(/kb/gim,"").replace(/mb/gim,"").replace(/gb/gim,"");let r=parseInt(i);isNaN(r)&&(r=0),n[e]=r}}));const i=null!==(e=n.memavailable)&&void 0!==e?e:n.memfree,r=n.memtotal;u.freemem=1024*i,u.totalmem=1024*r,u.memUsage=(u.totalmem-u.freemem)/u.totalmem,s.default.cpuUsage((e=>u.cpuUsage=e))}catch(e){a()}}():"win32"===r.default.platform()?(u.freemem=r.default.freemem(),u.totalmem=r.default.totalmem(),u.memUsage=(r.default.totalmem()-r.default.freemem())/r.default.totalmem(),void s.default.cpuUsage((e=>u.cpuUsage=e))):a()),3e3),t.systemInfo=function(){return u}},2126:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1017)),s=i(n(4470));class o{checkFileName(e){const t=["\\","/",".."];for(const n of t)if(e.includes(n))return!1;return!0}store(e,t,n){const i=r.default.join(o.STIRAGE_DATA_PATH,e);if(s.default.existsSync(i)||s.default.mkdirsSync(i),!this.checkFileName(t))throw new Error(`UUID ${t} 不符合规范`);const u=r.default.join(i,`${t}.json`),a=JSON.stringify(n,null,4);s.default.writeFileSync(u,a,{encoding:"utf-8"})}defineAttr(e,t){for(const n of Object.keys(e)){const i=t[n];void 0!==i&&(i instanceof Array?e[n]=i:i instanceof Object&&"object"==typeof i?this.defineAttr(e[n],i):e[n]=i)}return e}load(e,t,n){const i=r.default.join(o.STIRAGE_DATA_PATH,e);if(s.default.existsSync(i)||s.default.mkdirsSync(i),!this.checkFileName(n))throw new Error(`UUID ${n} 不符合规范`);const u=r.default.join(i,`${n}.json`);if(!s.default.existsSync(u))return null;const a=s.default.readFileSync(u,{encoding:"utf-8"}),l=JSON.parse(a),d=new t;return this.defineAttr(d,l)}list(e){const t=r.default.join(o.STIRAGE_DATA_PATH,e);s.default.existsSync(t)||s.default.mkdirsSync(t);const n=s.default.readdirSync(t),i=new Array;return n.forEach((e=>{i.push(e.replace(r.default.extname(e),""))})),i}delete(e,t){const n=r.default.join(o.STIRAGE_DATA_PATH,e,`${t}.json`);s.default.existsSync(n)&&s.default.removeSync(n)}}o.STIRAGE_DATA_PATH=r.default.normalize(r.default.join(process.cwd(),"data")),o.STIRAGE_INDEX_PATH=r.default.normalize(r.default.join(process.cwd(),"data","index")),t.default=new o},1423:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.FILENAME_BLACKLIST=void 0,t.FILENAME_BLACKLIST=["\\","/",".","'",'"',"?","*","<",">"]},521:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteServiceConfig=void 0,t.RemoteServiceConfig=class{constructor(){this.ip="",this.port=24444,this.remarks="",this.apiKey="",this.connectOpts={multiplex:!1,reconnectionDelayMax:3e3,timeout:3e3,reconnection:!0,reconnectionAttempts:20}}}},3204:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const u=s(n(8087)),a=n(8264),l=o(n(5153)),d=o(n(5739));class c{constructor(e,t){this.uuid=null,this.available=!1,this.socket=null,this.instanceStream=new d.default,this.uuid=e,this.config=t}connect(e){if(e&&(this.config.connectOpts=e),this.available&&(a.logger.info(`[${this.uuid}] 用户发起重连已可用状态的远程服务，正在重置连接通道`),this.disconnect()),this.socket&&this.socket.hasListeners("connect"))return a.logger.info(`[${this.uuid}] 用户发起重复连接请求，现进行重置连接配置`),this.refreshReconnect();let t=`ws://${this.config.ip}:${this.config.port}`;0!==this.config.ip.indexOf("wss://")&&0!==this.config.ip.indexOf("ws://")||(t=`${this.config.ip}:${this.config.port}`),a.logger.info(`[${this.uuid}] 面板正在尝试连接远程服务 ${t}`),this.socket=u.connect(t,e),this.socket.on("connect",(async()=>{a.logger.info(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 已连接`),await this.onConnect()})),this.socket.on("disconnect",(async()=>{a.logger.info(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 已断开`),await this.onDisconnect()})),this.socket.on("connect_error",(async e=>{await this.onDisconnect()}))}async auth(e){e&&(this.config.apiKey=e);try{return!0===await new l.default(this).request("auth",this.config.apiKey,5e3,!0)?(this.available=!0,a.logger.info(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 验证成功`),!0):(this.available=!1,a.logger.warn(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 验证失败`),!1)}catch(e){return a.logger.warn(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 验证错误`),!1}}emit(e,t){return this.socket.emit(e,t)}async onDisconnect(){this.available=!1}async onConnect(){return await this.auth(this.config.apiKey)}disconnect(){this.socket&&(a.logger.info(`[${this.uuid}] [${this.config.ip}:${this.config.port}] Socket 已主动释放连接`),this.socket.removeAllListeners(),this.socket.disconnect(),this.socket.close(),delete this.socket),this.socket=null,this.available=!1}refreshReconnect(){this.disconnect(),this.connect()}}t.default=c,c.STATUS_OK=200,c.STATUS_ERR=500},3149:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.httpPort=23333,this.httpIp=null,this.dataPort=23334,this.forwardType=1,this.crossDomain=!1,this.gzip=!1,this.maxCompress=1,this.maxDonwload=10,this.zipType=1,this.loginCheckIp=!0,this.loginInfo="",this.canFileManager=!0}}},1677:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.User=void 0,t.User=class{constructor(){this.uuid="",this.userName="",this.passWord="",this.salt="",this.permission=0,this.registerTime="",this.loginTime="",this.instances=[],this.apiKey="",this.isInit=!1}}},4069:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.index=void 0;const r=i(n(1511));n(6469),n(4419),n(2195),n(237);const s=i(n(658)),o=i(n(3176)),u=i(n(3665)),a=i(n(3601)),l=i(n(1594)),d=i(n(4225)),c=i(n(5598)),f=i(n(556)),g=i(n(286)),y=i(n(8179)),p=i(n(4374)),m=i(n(8377)),_=i(n(859));t.index=function(e){const t=new r.default({prefix:"/api"});t.use(s.default.routes()).use(s.default.allowedMethods()),t.use(c.default.routes()).use(c.default.allowedMethods()),t.use(d.default.routes()).use(d.default.allowedMethods()),t.use(f.default.routes()).use(f.default.allowedMethods()),t.use(g.default.routes()).use(g.default.allowedMethods()),t.use(y.default.routes()).use(y.default.allowedMethods()),t.use(p.default.routes()).use(p.default.allowedMethods()),t.use(u.default.routes()).use(u.default.allowedMethods()),t.use(a.default.routes()).use(a.default.allowedMethods()),t.use(o.default.routes()).use(o.default.allowedMethods()),t.use(m.default.routes()).use(m.default.allowedMethods()),t.use(l.default.routes()).use(l.default.allowedMethods()),t.use(_.default.routes()).use(_.default.allowedMethods()),e.use(t.routes()).use(t.allowedMethods())}},6746:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const r=i(n(299)),s=i(n(6469)),o=n(3210);e.exports=e=>async(t,n)=>{if(t.query.apikey){const i=String(t.query.apikey),r=o.getUuidByApiKey(i);return r&&r.permission>=e.level?await n():function(e){e.status=403,e.body="[Forbidden] API 密钥不正确"}(t)}if(!1!==e.token){if(!o.isAjax(t))return function(e){e.status=403,e.body="[Forbidden] 无法找到请求头 x-requested-with: xmlhttprequest"}(t);if(t.query.token!==t.session.token)return function(e){e.status=403,e.body="[Forbidden] 令牌(Token)验证失败，拒绝访问"}(t)}if(isNaN(parseInt(e.level)))return await n();if(!0===t.session.login&&t.session.uuid&&t.session.userName){const i=s.default.getInstance(t.session.uuid);if(i&&i.permission>=e.level)return await n()}return r.default.set(o.ILLEGAL_ACCESS_KEY,r.default.get(o.ILLEGAL_ACCESS_KEY,0)+1),function(e){e.status=403,e.body="[Forbidden] 权限不足"}(t)}},8145:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.middleware=void 0;const r=n(2781),s=i(n(4419)),o=n(6547);t.middleware=async function(e,t){e.url.startsWith("/api/")&&s.default.addRequestCount();try{await t()}catch(t){e.body=t}if(o.systemConfig.crossDomain&&(e.response.set("Access-Control-Allow-Origin","*"),e.response.set("Access-Control-Allow-Methods","PUT, POST, GET, DELETE, OPTIONS"),e.response.set("Access-Control-Allow-Headers","Content-Type, Content-Length, Authorization, Accept, X-Requested-With")),e.cookies.set("MCSManager","Copyright 2021 Suwings"),e.response.set("X-Powered-By","MCSManager"),e.body instanceof Error){const t=e.body;return e.status=500,void(e.body=JSON.stringify({status:e.status,data:t.message,time:(new Date).getTime()}))}if(!(e.body instanceof r.Stream)){if(404==e.status)return e.status=404,void(e.body=JSON.stringify({status:e.status,data:"[404] Not Found",time:(new Date).getTime()}));if("string"!=typeof e.body){if(null===e.body||!1===e.body||void 0===e.body)return e.status=500,void(e.body=JSON.stringify({status:500,data:e.body||null,time:(new Date).getTime()}));200!=e.status||(e.body=JSON.stringify({status:e.status,data:e.body,time:(new Date).getTime()}))}else{const t=e.status,n=e.body;e.body=JSON.stringify({status:t,data:n,time:(new Date).getTime()})}}}},5542:e=>{function t(e,t){if(e){for(const n in t){const i=t[n];if(null==e[n]||""===e[n])return!1;if(i!==Number)if(i!==String)if(i!==Date){if(i===Array&&!(e[n]instanceof Array)){const t=JSON.parse(e[n]);if(!(t instanceof Array))return!1;e[n]=t}if(i===Object&&!e[n])return!1}else{const t=new Date(e[n]).toString();if("Invalid Date"==t||null==t)return!1;e[n]=new Date(e[n])}else e[n]=String(e[n]);else if(e[n]=Number(e[n]),isNaN(e[n]))return!1}return!0}return!1}e.exports=function(e){return async(n,i)=>{try{let r=!0;return e.params&&!t(n.params,e.params)&&(r=!1),e.query&&!t(n.query,e.query)&&(r=!1),e.body&&!t(n.request.body,e.body)&&(r=!1),r?await i():function(e){e.status=400,e.body="错误请求：请求参数不正确"}(n)}catch(e){const t=e;n.status=500,n.body=`${t.message}`}}}},4374:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(5542)),u=n(3210),a=i(n(6469)),l=new r.default({prefix:"/auth"});l.post("/",s.default({level:10}),o.default({body:{username:String,password:String,permission:Number}}),(async e=>{const t=String(e.request.body.username),n=String(e.request.body.password),i=Number(e.request.body.permission);if(t.length<2||t.length>18)throw new Error("错误的用户名长度规则");if(n.length<6||n.length>18)throw new Error("错误的密码长度规则");if(a.default.existUserName(t))throw new Error("用户名已经被占用");const r=u.register(e,t,n,i);e.body=r})),l.del("/",s.default({level:10}),(async e=>{const t=e.request.body;try{for(const e of t)a.default.deleteInstance(e);e.body=!0}catch(t){e.throw(500,"无法完成用户数据删除")}})),l.get("/search",s.default({level:10}),o.default({query:{page:Number,page_size:Number}}),(async e=>{const t=e.query.userName,n=Number(e.query.page),i=Number(e.query.page_size),r={};t&&(r.userName=`%${t}%`);let s=a.default.getQueryWrapper().selectPage(r,n,i);s=JSON.parse(JSON.stringify(s)),s.data.forEach((e=>{delete e.passWord,delete e.salt})),e.body=s})),t.default=l},859:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(5542)),u=i(n(2195)),a=i(n(5153)),l=new r.default({prefix:"/environment"});l.get("/image",s.default({level:10}),o.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=u.default.getInstance(t),i=await new a.default(n).request("environment/images",{});e.body=i}catch(t){e.body=t}})),l.post("/image",s.default({level:10}),o.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=e.request.body,i=u.default.getInstance(t),r=await new a.default(i).request("environment/new_image",n);e.body=r}catch(t){e.body=t}})),l.delete("/image",s.default({level:10}),o.default({query:{remote_uuid:String,imageId:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.imageId),i=u.default.getInstance(t),r=await new a.default(i).request("environment/del_image",{imageId:n});e.body=r}catch(t){e.body=t}})),l.get("/containers",s.default({level:10}),o.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=u.default.getInstance(t),i=await new a.default(n).request("environment/containers",{});e.body=i}catch(t){e.body=t}})),l.get("/networkModes",s.default({level:10}),o.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=u.default.getInstance(t),i=await new a.default(n).request("environment/networkModes",{});e.body=i}catch(t){e.body=t}})),l.get("/progress",s.default({level:10}),o.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=u.default.getInstance(t),i=await new a.default(n).request("environment/progress",{});e.body=i}catch(t){e.body=t}})),t.default=l},4225:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(5542)),u=i(n(2195)),a=i(n(5153)),l=n(6730),d=n(1254),c=new r.default({prefix:"/instance"});c.get("/",s.default({level:10}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=u.default.getInstance(t),r=await new a.default(i).request("instance/detail",{instanceUuid:n});e.body=r}catch(t){e.body=t}})),c.post("/",s.default({level:10}),o.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=e.request.body,i=u.default.getInstance(t),r=await new a.default(i).request("instance/new",n);e.body=r}catch(t){e.body=t}})),c.post("/upload",s.default({level:10}),o.default({query:{remote_uuid:String,upload_dir:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=e.request.body,i=u.default.getInstance(t),r=(await new a.default(i).request("instance/new",n)).instanceUuid;if(!r)throw new Error("创建实例失败");const s=`${i.config.ip}:${i.config.port}`,o=d.timeUuid();await new a.default(i).request("passport/register",{name:"upload",password:o,parameter:{uploadDir:".",instanceUuid:r}}),e.body={instanceUuid:r,password:o,addr:s}}catch(t){e.body=t}})),c.put("/",s.default({level:10}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body,r=u.default.getInstance(t),s=await new a.default(r).request("instance/update",{instanceUuid:n,config:i});e.body=s}catch(t){e.body=t}})),c.delete("/",s.default({level:10}),o.default({query:{remote_uuid:String},body:{uuids:Object,deleteFile:Boolean}}),(async e=>{try{const t=String(e.query.remote_uuid),n=e.request.body.uuids,i=e.request.body.deleteFile,r=u.default.getInstance(t),s=await new a.default(r).request("instance/delete",{instanceUuids:n,deleteFile:i});e.body=s}catch(t){e.body=t}})),c.post("/multi_open",s.default({level:10}),(async e=>{try{const t=e.request.body;l.multiOperationForwarding(t,(async(e,t)=>{const n=u.default.getInstance(e);new a.default(n).request("instance/open",{instanceUuids:t}).catch((()=>{}))})),e.body=!0}catch(t){e.body=t}})),c.post("/multi_stop",s.default({level:10}),(async e=>{try{const t=e.request.body;l.multiOperationForwarding(t,(async(e,t)=>{const n=u.default.getInstance(e);new a.default(n).request("instance/stop",{instanceUuids:t}).catch((()=>{}))})),e.body=!0}catch(t){e.body=t}})),c.post("/multi_kill",s.default({level:10}),(async e=>{try{const t=e.request.body;l.multiOperationForwarding(t,(async(e,t)=>{const n=u.default.getInstance(e);new a.default(n).request("instance/kill",{instanceUuids:t}).catch((e=>{}))})),e.body=!0}catch(t){e.body=t}})),t.default=c},658:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(2195)),u=i(n(4419)),a=i(n(5153)),l=i(n(2037)),d=n(9857),c=n(6296),f=i(n(299)),g=n(3210),y=new r.default({prefix:"/overview"});y.get("/",s.default({level:10,token:!1}),(async e=>{const t=new Array;for(const e of o.default.services.entries()){const n=e[1];let i={};try{i=await new a.default(n).request("info/overview")}catch(e){}i.uuid=n.uuid,i.ip=n.config.ip,i.port=n.config.port,i.available=n.available,i.remarks=n.config.remarks,t.push(i)}const n=d.systemInfo(),i={version:c.getVersion(),specifiedDaemonVersion:c.specifiedDaemonVersion(),process:{cpu:n.processCpu,memory:process.memoryUsage().rss,cwd:n.cwd},record:{logined:f.default.get(g.LOGIN_COUNT,0),illegalAccess:f.default.get(g.ILLEGAL_ACCESS_KEY,0),banips:f.default.get(g.BAN_IP_COUNT,0),loginFailed:f.default.get(g.LOGIN_FAILED_COUNT_KEY,0)},system:{user:l.default.userInfo(),time:(new Date).toLocaleString(),totalmem:n.totalmem,freemem:n.freemem,type:n.type,version:l.default.version(),node:process.version,hostname:n.hostname,loadavg:n.loadavg,platform:n.platform,release:n.release,uptime:l.default.uptime(),cpu:n.cpuUsage},chart:{system:u.default.getSystemChartArray(),request:u.default.getStatusChartArray()},remoteCount:o.default.count(),remote:t};e.body=i})),t.default=y},556:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(5542)),u=i(n(2195)),a=i(n(5153)),l=new r.default({prefix:"/service"});l.get("/remote_services_list",s.default({level:10}),(async e=>{const t=new Array;for(const e of u.default.services.entries()){const n=e[1];t.push({uuid:n.uuid,ip:n.config.ip,port:n.config.port,available:n.available,remarks:n.config.remarks})}e.body=t})),l.get("/remote_service_instances",s.default({level:10}),o.default({query:{remote_uuid:String,page:Number,page_size:Number}}),(async e=>{const t=String(e.query.remote_uuid),n=Number(e.query.page),i=Number(e.query.page_size),r=e.query.instance_name,s=u.default.getInstance(t),o=await new a.default(s).request("instance/select",{page:n,pageSize:i,condition:{instanceName:r}});e.body=o})),l.get("/remote_services_system",s.default({level:10}),(async e=>{const t=new Array;for(const e of u.default.services.entries()){const n=e[1];let i=null;try{i=await new a.default(n).request("info/overview")}catch(e){continue}t.push(i)}e.body=t})),l.get("/remote_services",s.default({level:10}),(async e=>{const t=new Array;for(const e of u.default.services.entries()){const n=e[1];let i=[];try{i=await new a.default(n).request("instance/overview")}catch(e){}t.push({uuid:n.uuid,ip:n.config.ip,port:n.config.port,available:n.available,remarks:n.config.remarks,instances:i})}e.body=t})),l.post("/remote_service",s.default({level:10}),o.default({body:{apiKey:String,port:Number,ip:String,remarks:String}}),(async e=>{const t=e.request.body,n=u.default.registerRemoteService({apiKey:t.apiKey,port:t.port,ip:t.ip,remarks:t.remarks||""});e.body=n.uuid})),l.put("/remote_service",s.default({level:10}),o.default({query:{uuid:String}}),(async e=>{const t=String(e.request.query.uuid),n=e.request.body;if(!u.default.services.has(t))throw new Error("实例不存在");await u.default.edit(t,{port:n.port,ip:n.ip,apiKey:n.apiKey,remarks:n.remarks}),e.body=!0})),l.delete("/remote_service",s.default({level:10}),o.default({query:{uuid:String}}),(async e=>{const t=String(e.request.query.uuid);if(!u.default.services.has(t))throw new Error("实例不存在");await u.default.deleteRemoteService(t),e.body=!0})),l.get("/link_remote_service",s.default({level:10}),o.default({query:{uuid:String}}),(async e=>{const t=String(e.request.query.uuid);if(!u.default.services.has(t))throw new Error("实例不存在");try{u.default.getInstance(t).connect(),e.body=!0}catch(t){e.body=t}})),t.default=l},1594:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(5542)),u=n(6547),a=new r.default({prefix:"/overview"});a.get("/setting",s.default({level:10}),(async e=>{e.body=u.systemConfig})),a.put("/setting",o.default({body:{}}),s.default({level:10}),(async e=>{const t=e.request.body;if(t)return null!=t.httpIp&&(u.systemConfig.httpIp=t.httpIp),null!=t.httpPort&&(u.systemConfig.httpPort=t.httpPort),null!=t.crossDomain&&(u.systemConfig.crossDomain=t.crossDomain),null!=t.gzip&&(u.systemConfig.gzip=t.gzip),null!=t.maxCompress&&(u.systemConfig.maxCompress=t.maxCompress),null!=t.maxDonwload&&(u.systemConfig.maxDonwload=t.maxDonwload),null!=t.zipType&&(u.systemConfig.zipType=t.zipType),null!=t.loginCheckIp&&(u.systemConfig.loginCheckIp=t.loginCheckIp),null!=t.forwardType&&(u.systemConfig.forwardType=Number(t.forwardType)),null!=t.dataPort&&(u.systemConfig.dataPort=Number(t.dataPort)),null!=t.loginInfo&&(u.systemConfig.loginInfo=String(t.loginInfo)),null!=t.canFileManager&&(u.systemConfig.canFileManager=Boolean(t.canFileManager)),u.saveSystemConfig(u.systemConfig),void(e.body="OK");e.body=new Error("错误的配置方式")})),t.default=a},3176:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(6469)),u=new r.default({prefix:"/auth"});u.put("/",s.default({level:10}),(async e=>{const{uuid:t,config:n}=e.request.body,{passWord:i}=n;if(i&&!o.default.validatePassword(i))throw new Error("密码不规范，必须为拥有大小写字母，数字，长度在9到36之间");try{o.default.edit(t,n),e.body=!0}catch(t){e.throw(500,t.message)}})),u.get("/overview",s.default({level:10}),(async e=>{const t=[];o.default.objects.forEach((e=>{t.push({uuid:e.uuid,userName:e.userName,permission:e.permission,instances:e.instances,loginTime:e.loginTime,registerTime:e.loginTime})})),e.body=t})),t.default=u},8179:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(5542)),u=n(3210),a=i(n(2195)),l=i(n(5153)),d=n(7382),c=new r.default({prefix:"/protected_instance"});c.use((async(e,t)=>{const n=String(e.query.uuid),i=String(e.query.remote_uuid),r=u.getUserUuid(e);d.isHaveInstanceByUuid(r,i,n)?await t():(e.status=403,e.body="[Forbidden] [中间件] 参数不正确或非法访问实例")})),c.put("/low_permission",s.default({level:1}),o.default({query:{uuid:String,remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body,r={ie:String(i.ie),oe:String(i.oe),stopCommand:String(i.stopCommand)},s=a.default.getInstance(t),o=await new l.default(s).request("instance/update",{instanceUuid:n,config:r});e.body=o}catch(t){e.body=t}})),t.default=c},286:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(5542)),u=i(n(2195)),a=i(n(5153)),l=n(1254),d=n(3210),c=n(7382),f=n(6547),g=new r.default({prefix:"/files"});g.use((async(e,t)=>{const n=String(e.query.uuid),i=String(e.query.remote_uuid),r=d.getUserUuid(e);if(!1===f.systemConfig.canFileManager&&d.getUserPermission(e)<10)return e.status=403,void(e.body=new Error("管理员已限制全部用户使用文件管理功能"));c.isHaveInstanceByUuid(r,i,n)?await t():(e.status=403,e.body="[Forbidden] [中间件] 参数不正确或非法访问实例")})),g.get("/status",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=u.default.getInstance(t),r=await new a.default(i).request("file/status",{instanceUuid:n});e.body=r}catch(t){e.body=t}})),g.get("/list",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String,target:String,page:Number,page_size:Number}}),(async e=>{try{const t=String(e.query.target),n=String(e.query.remote_uuid),i=String(e.query.uuid),r=Number(e.query.page),s=Number(e.query.page_size),o=u.default.getInstance(n),l=await new a.default(o).request("file/list",{instanceUuid:i,target:t,pageSize:s,page:r});e.body=l}catch(t){e.body=t}})),g.post("/mkdir",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String},body:{target:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.request.body.target),r=u.default.getInstance(t),s=await new a.default(r).request("file/mkdir",{target:i,instanceUuid:n});e.body=s}catch(t){e.body=t}})),g.put("/",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String},body:{target:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.request.body.target),r=e.request.body.text,s=u.default.getInstance(t),o=await new a.default(s).request("file/edit",{instanceUuid:n,target:i,text:r});e.body=o}catch(t){e.body=t}})),g.post("/copy",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String},body:{targets:Array}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body.targets,r=u.default.getInstance(t),s=await new a.default(r).request("file/copy",{instanceUuid:n,targets:i});e.body=s}catch(t){e.body=t}})),g.put("/move",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String},body:{targets:Array}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body.targets,r=u.default.getInstance(t),s=await new a.default(r).request("file/move",{instanceUuid:n,targets:i});e.body=s}catch(t){e.body=t}})),g.delete("/",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String},body:{targets:Object}}),(async e=>{try{const t=String(e.query.remote_uuid),n=e.query.uuid,i=e.request.body.targets,r=u.default.getInstance(t),s=await new a.default(r).request("file/delete",{instanceUuid:n,targets:i});e.body=s}catch(t){e.body=t}})),g.post("/compress",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String},body:{source:String,targets:Object,type:Number,code:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.request.body.source),r=e.request.body.targets,s=Number(e.request.body.type),o=String(e.request.body.code),l=u.default.getInstance(t);await new a.default(l).request("file/compress",{instanceUuid:n,targets:r,source:i,type:s,code:o}),e.body=!0}catch(t){e.body=t}})),g.all("/download",s.default({level:1}),o.default({query:{uuid:String,remote_uuid:String,file_name:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.file_name),r=u.default.getInstance(t),s=`${r.config.ip}:${r.config.port}`,o=l.timeUuid();await new a.default(r).request("passport/register",{name:"download",password:o,parameter:{fileName:i,instanceUuid:n}}),e.body={password:o,addr:s}}catch(t){e.body=t}})),g.all("/upload",s.default({level:1}),o.default({query:{uuid:String,remote_uuid:String,upload_dir:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.upload_dir),r=u.default.getInstance(t),s=`${r.config.ip}:${r.config.port}`,o=l.timeUuid();await new a.default(r).request("passport/register",{name:"upload",password:o,parameter:{uploadDir:i,instanceUuid:n}}),e.body={password:o,addr:s}}catch(t){e.body=t}})),t.default=g},3601:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=n(3210),u=i(n(6469)),a=n(3210),l=i(n(2195)),d=i(n(5153)),c=n(7382),f=i(n(5542)),g=n(5828),y=new r.default({prefix:"/auth"});y.get("/token",s.default({level:1,token:!1}),(async e=>{if(!a.isAjax(e))throw new Error("The request is not an Ajax request.");e.body=a.getToken(e)})),y.get("/",s.default({level:1,token:!1}),(async e=>{let t=o.getUserUuid(e);const n=e.query.advanced;if(c.isTopPermissionByUuid(t)&&e.query.uuid&&(t=String(e.query.uuid)),a.isAjax(e)){const i=u.default.getInstance(t);if(!i)throw new Error("此用户UID不存在");let r=[];if(n){const e=i.instances;for(const t of e){const e=l.default.getInstance(t.serviceUuid);if(e)try{let n=await new d.default(e).request("instance/section",{instanceUuids:[t.instanceUuid]});n=n[0],r.push({hostIp:`${e.config.ip}:${e.config.port}`,remarks:e.config.remarks,instanceUuid:n.instanceUuid,serviceUuid:e.uuid,status:n.status,nickname:n.config.nickname,ie:n.config.ie,oe:n.config.oe,endTime:n.config.endTime,lastDatetime:n.config.lastDatetime,stopCommand:n.config.stopCommand})}catch(n){r.push({hostIp:`${e.config.ip}:${e.config.port}`,instanceUuid:t.instanceUuid,serviceUuid:t.serviceUuid,status:-1,nickname:"--"})}else r.push({hostIp:"-- Unknown --",instanceUuid:t.instanceUuid,serviceUuid:t.serviceUuid,status:-1,nickname:"--",remarks:"--"})}}else r=i.instances;e.body={uuid:i.uuid,userName:i.userName,loginTime:i.loginTime,registerTime:i.registerTime,instances:r,permission:i.permission,token:a.getToken(e),apiKey:i.apiKey,isInit:i.isInit}}})),y.put("/update",s.default({level:1}),f.default({body:{}}),(async e=>{const t=o.getUserUuid(e);if(t){const n=e.request.body,{passWord:i,isInit:r}=n;if(!u.default.validatePassword(i))throw new Error("密码不规范，必须为拥有大小写字母，数字，长度在9到36之间");u.default.edit(t,{passWord:i,isInit:r}),e.body=!0}})),y.put("/api",s.default({level:1}),f.default({body:{}}),(async e=>{const t=o.getUserUuid(e),n=e.request.body.enable,i=u.default.getInstance(t);let r="";try{i&&(n?(r=g.v4().replace(/-/gim,""),u.default.edit(t,{apiKey:r})):u.default.edit(t,{apiKey:""})),e.body=r}catch(t){e.body=t}})),t.default=y},8377:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(5542)),u=i(n(2195)),a=i(n(5153)),l=n(3210),d=n(7382),c=n(1423),f=new r.default({prefix:"/protected_schedule"});f.use((async(e,t)=>{const n=String(e.query.uuid),i=String(e.query.remote_uuid),r=l.getUserUuid(e);d.isHaveInstanceByUuid(r,i,n)?await t():(e.status=403,e.body="[Forbidden] [中间件] 参数不正确或非法访问实例")})),f.get("/",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=await new a.default(u.default.getInstance(t)).request("schedule/list",{instanceUuid:n});e.body=i}catch(t){e.body=t}})),f.post("/",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String},body:{name:String,count:Number,time:String,action:String,type:Number}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body,r=String(i.name);c.FILENAME_BLACKLIST.forEach((e=>{if(r.includes(e))throw new Error("非法的计划任务名")})),e.body=await new a.default(u.default.getInstance(t)).request("schedule/register",{instanceUuid:n,name:r,count:Number(i.count),time:String(i.time),action:String(i.action),payload:String(i.payload),type:Number(i.type)})}catch(t){e.body=t}})),f.delete("/",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.task_name);e.body=await new a.default(u.default.getInstance(t)).request("schedule/delete",{instanceUuid:n,name:i})}catch(t){e.body=t}})),t.default=f},5598:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(6746)),o=i(n(5542)),u=i(n(2195)),a=i(n(5153)),l=n(1254),d=n(3210),c=n(7382),f=new r.default({prefix:"/protected_instance"});f.use((async(e,t)=>{const n=String(e.query.uuid),i=String(e.query.remote_uuid),r=d.getUserUuid(e);c.isHaveInstanceByUuid(r,i,n)?await t():(e.status=403,e.body="[Forbidden] [中间件] 参数不正确或非法访问实例")})),f.all("/open",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=u.default.getInstance(t),r=await new a.default(i).request("instance/open",{instanceUuids:[n]});e.body=r}catch(t){e.body=t}})),f.all("/stop",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=u.default.getInstance(t),r=await new a.default(i).request("instance/stop",{instanceUuids:[n]});e.body=r}catch(t){e.body=t}})),f.all("/command",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String,command:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.command),r=u.default.getInstance(t),s=await new a.default(r).request("instance/command",{instanceUuid:n,command:i});e.body=s}catch(t){e.body=t}})),f.all("/restart",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=u.default.getInstance(t),r=await new a.default(i).request("instance/restart",{instanceUuids:[n]});e.body=r}catch(t){e.body=t}})),f.all("/kill",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=u.default.getInstance(t),r=await new a.default(i).request("instance/kill",{instanceUuids:[n]});e.body=r}catch(t){e.body=t}})),f.post("/asynchronous",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String,task_name:String},body:{}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.task_name),r=e.body,s=u.default.getInstance(t),o=await new a.default(s).request("instance/asynchronous",{instanceUuid:n,taskName:i,parameter:r});e.body=o}catch(t){e.body=t}})),f.all("/stop_asynchronous",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=u.default.getInstance(t),r=await new a.default(i).request("instance/stop_asynchronous",{instanceUuid:n});e.body=r}catch(t){e.body=t}})),f.post("/stream_channel",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=u.default.getInstance(t),r=`${i.config.ip}:${i.config.port}`,s=l.timeUuid();await new a.default(i).request("passport/register",{name:"stream_channel",password:s,parameter:{instanceUuid:n}}),e.body={password:s,addr:r}}catch(t){e.body=t}})),f.post("/process_config/list",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body.files,r=u.default.getInstance(t),s=await new a.default(r).request("instance/process_config/list",{instanceUuid:n,files:i});e.body=s}catch(t){e.body=t}})),f.get("/process_config/file",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String,fileName:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.fileName),r=String(e.query.type),s=u.default.getInstance(t),o=await new a.default(s).request("instance/process_config/file",{instanceUuid:n,fileName:i,config:null,type:r});e.body=o}catch(t){e.body=t}})),f.put("/process_config/file",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String,fileName:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.fileName),r=String(e.query.type),s=e.request.body,o=u.default.getInstance(t),l=await new a.default(o).request("instance/process_config/file",{instanceUuid:n,fileName:i,config:s,type:r});e.body=l}catch(t){e.body=t}})),f.put("/instance_update",s.default({level:1}),o.default({query:{uuid:String,remote_uuid:String},body:{pingConfig:Object,eventTask:Object,terminalOption:Object}}),(async e=>{var t,n,i,r,s,o,l,d,c,f,g,y;try{const p=String(e.query.remote_uuid),m=String(e.query.uuid),_=e.request.body,h={ip:String(null===(t=_.pingConfig)||void 0===t?void 0:t.ip),port:Number(null===(n=_.pingConfig)||void 0===n?void 0:n.port),type:null===(i=_.pingConfig)||void 0===i?void 0:i.type},v={autoStart:Boolean(null===(r=_.eventTask)||void 0===r?void 0:r.autoStart),autoRestart:Boolean(null===(s=_.eventTask)||void 0===s?void 0:s.autoRestart)},S={haveColor:Boolean(null===(o=_.terminalOption)||void 0===o?void 0:o.haveColor),pty:Boolean(null===(l=_.terminalOption)||void 0===l?void 0:l.pty),ptyWindowCol:Number(null===(d=_.terminalOption)||void 0===d?void 0:d.ptyWindowCol),ptyWindowRow:Number(null===(c=_.terminalOption)||void 0===c?void 0:c.ptyWindowRow)},b=Number(null==_?void 0:_.crlf),w=_.oe?String(null==_?void 0:_.oe):null,q=_.ie?String(null==_?void 0:_.ie):null,I=_.stopCommand?String(_.stopCommand):null,U=u.default.getInstance(p),C=await new a.default(U).request("instance/update",{instanceUuid:m,config:{pingConfig:null!=(null===(f=_.pingConfig)||void 0===f?void 0:f.ip)?h:null,eventTask:null!=(null===(g=_.eventTask)||void 0===g?void 0:g.autoStart)?v:null,terminalOption:null!=(null===(y=_.terminalOption)||void 0===y?void 0:y.pty)?S:null,crlf:b,oe:w,ie:q,stopCommand:I}});e.body=C}catch(t){e.body=t}})),f.get("/outputlog",s.default({level:1}),o.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=u.default.getInstance(t),r=await new a.default(i).request("instance/outputlog",{instanceUuid:n});e.body=r}catch(t){e.body=t}})),t.default=f},3665:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(1511)),s=i(n(5542)),o=i(n(6746)),u=n(3210),a=n(6547),l=i(n(6469)),d=n(8264),c=new r.default({prefix:"/auth"});c.post("/login",o.default({token:!1,level:null}),s.default({body:{username:String,password:String}}),(async e=>{const t=String(e.request.body.username),n=String(e.request.body.password);if(!u.checkBanIp(e))throw new Error("身份验证次数过多，您的 IP 地址已被锁定 10 分钟");if(u.check(e))return e.body="Logined";if(!u.login(e,t,n))throw new Error("账号或密码错误");e.body=!0})),c.get("/logout",o.default({token:!1,level:null}),(async e=>{u.logout(e),e.body=!0})),c.all("/login_info",o.default({token:!1,level:null}),(async e=>{e.body={loginInfo:a.systemConfig.loginInfo}})),c.all("/status",o.default({token:!1,level:null}),(async e=>{let t=!0;0===l.default.objects.size&&(t=!1),e.body={isInstall:t}})),c.all("/install",o.default({token:!1,level:null}),s.default({body:{username:String,password:String}}),(async e=>{const t=e.request.body.username,n=e.request.body.password;if(0===l.default.objects.size){if(!l.default.validatePassword(n))throw new Error("密码不规范，必须为拥有大小写字母，数字，长度在9到36之间");return d.logger.info(`[安装面板] 正在初始化面板管理员账号: ${t}`),l.default.create({userName:t,passWord:n,permission:10}),u.login(e,t,n),e.body=!0}throw new Error("Panel installed")})),t.default=c},3858:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UniversalRemoteSubsystem=void 0;const i=n(5828);t.UniversalRemoteSubsystem=class{constructor(){this.services=new Map}setInstance(e,t){if(this.services.get(e))throw new Error("Instance already exists");this.services.set(e,t)}getInstance(e){return this.services.get(e)}deleteInstance(e){return this.services.delete(e)}randdomUuid(){return i.v4().replace(/-/gim,"")}}},6730:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.multiOperationForwarding=void 0,t.multiOperationForwarding=function(e,t){const n=new Map;for(const t of e){const e=t.serviceUuid,i=t.instanceUuid;n.has(e)?n.get(e).push(i):n.set(e,[i])}for(const e of n)t(e[0],e[1])}},8264:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.fullLocalTime=t.fullTime=t.logger=void 0;const r=i(n(4470)),s=i(n(8094)),o="logs/current.log";if(r.default.existsSync(o)){const e=new Date,t=`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()}_${e.getHours()}-${e.getMinutes()}-${e.getSeconds()}`;r.default.renameSync(o,`logs/${t}.log`)}s.default.configure({appenders:{out:{type:"stdout",layout:{type:"pattern",pattern:"[%d{MM/dd hh:mm:ss}] [%[%p%]] %m"}},app:{type:"file",filename:o,layout:{type:"pattern",pattern:"%d %p %m"}}},categories:{default:{appenders:["out","app"],level:"info"}}});const u=s.default.getLogger("default");t.logger=u,t.fullTime=function(){const e=new Date;return`${e.getFullYear()}/${e.getMonth()}/${e.getDate()}`},t.fullLocalTime=function(){return(new Date).toLocaleTimeString()}},3210:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getApiKey=t.isApiRequest=t.getUuidByApiKey=t.checkBanIp=t.isAjax=t.getToken=t.getUserUuid=t.getUserNameBySession=t.getUserPermission=t.register=t.logout=t.check=t.login=t.LOGIN_FAILED_COUNT_KEY=t.LOGIN_COUNT=t.ILLEGAL_ACCESS_KEY=t.LOGIN_FAILED_KEY=t.BAN_IP_COUNT=void 0;const r=i(n(6469)),s=n(1254),o=i(n(299)),u=n(6547),a=n(8264);function l(e){const t=r.default.getQueryWrapper().selectPage({apiKey:e},1,1);return 1===t.total?t.data[0]:null}function d(e){return!!e.query.apikey}function c(e){return String(e.query.apikey)}t.BAN_IP_COUNT="banip",t.LOGIN_FAILED_KEY="loginFailed",t.ILLEGAL_ACCESS_KEY="illegalAccess",t.LOGIN_COUNT="loginCount",t.LOGIN_FAILED_COUNT_KEY="loginFailedCount",t.login=function(e,n,i){o.default.set(t.LOGIN_COUNT,o.default.get(t.LOGIN_COUNT,0)+1);const u=e.socket.remoteAddress;if(r.default.checkUser({userName:n,passWord:i})){const i=o.default.get(t.LOGIN_FAILED_KEY);i&&delete i[u];const l=r.default.getUserByUserName(n);return l.loginTime=(new Date).toLocaleString(),e.session.login=!0,e.session.userName=n,e.session.uuid=l.uuid,e.session.token=s.timeUuid(),e.session.save(),a.logger.info(`[Logined Event] IP: ${u} 成功登录账号 ${n}`),a.logger.info(`Token: ${e.session.token}`),e.session.token}return o.default.set(t.LOGIN_FAILED_COUNT_KEY,o.default.get(t.LOGIN_FAILED_COUNT_KEY,0)+1),e.session.login=null,e.session.token=null,e.session.save(),a.logger.info(`[Logined Event] IP: ${u} 登录账号 ${n} 失败`),null},t.check=function(e){return!!(e.session.login&&e.session.userName&&e.session.token)},t.logout=function(e){return e.session.login=null,e.session.userName=null,e.session.uuid=null,e.session.token=null,e.session.save(),!0},t.register=function(e,t,n,i){let s=!0;return r.default.objects.forEach((e=>{e&&e.userName==t&&(s=!1)})),!!s&&(r.default.create({userName:t,passWord:n,permission:i}),!0)},t.getUserPermission=function(e){var t;let n=null;return n=d(e)?l(c(e)):r.default.getInstance(e.session.uuid),n&&null!==(t=n.permission)&&void 0!==t?t:0},t.getUserNameBySession=function(e){if(d(e)){const t=l(c(e));return t?t.userName:null}return e.session.userName},t.getUserUuid=function(e){if(d(e)){const t=l(c(e));return t?t.uuid:null}return e.session.uuid},t.getToken=function(e){return e.session.token},t.isAjax=function(e){return e.header["x-requested-with"]&&"xmlhttprequest"===e.header["x-requested-with"].toString().toLocaleLowerCase()},t.checkBanIp=function(e){o.default.map.has(t.LOGIN_FAILED_KEY)||o.default.set(t.LOGIN_FAILED_KEY,{});const n=o.default.get(t.LOGIN_FAILED_KEY),i=e.socket.remoteAddress;return n[i]>10&&!0===u.systemConfig.loginCheckIp?(999!=n[i]&&(o.default.set(t.BAN_IP_COUNT,o.default.get(t.BAN_IP_COUNT,0)+1),setTimeout((()=>{delete n[i],o.default.set(t.BAN_IP_COUNT,o.default.get(t.BAN_IP_COUNT,1)-1)}),6e5)),n[i]=999,!1):(isNaN(Number(n[i]))?n[i]=1:n[i]=Number(n[i])+1,!0)},t.getUuidByApiKey=l,t.isApiRequest=d,t.getApiKey=c},1254:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.timeUuid=void 0;const i=n(5828);t.timeUuid=function(){let e=i.v4().replace(/-/gim,"");return e+=(new Date).getTime()+"",e}},7382:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isHaveInstanceByUuid=t.isTopPermissionByUuid=t.isTopPermission=t.isHaveInstance=void 0;const r=i(n(6469));function s(e,t,n){if(o(e))return!0;if(e&&e.instances)for(const i of e.instances)if(t===i.serviceUuid&&n===i.instanceUuid)return!0;return!1}function o(e){return!!e&&e.permission>=10}t.isHaveInstance=s,t.isTopPermission=o,t.isTopPermissionByUuid=function(e){return o(r.default.getInstance(e))},t.isHaveInstanceByUuid=function(e,t,n){return s(r.default.getInstance(e),t,n)}},5153:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(5828),s=i(n(3204));class o extends Error{constructor(e){super(e)}}t.default=class{constructor(e){if(this.rService=e,!this.rService||!this.rService.socket)throw new Error("Unable to complete initialization, remote service does not exist.")}async request(e,t,n=6e3,i=!1){if(!this.rService.socket)throw new Error("The Socket must is SocketIOClient.Socket, Not null.");if(!this.rService.available&&!i)throw new Error("远程服务状态不可用，建议尝试重连远程服务或检查配置");if(!this.rService.socket.connected&&!i)throw new Error("远程服务连接不可用，无法发送数据");return new Promise(((i,u)=>{const a=[r.v4(),(new Date).getTime()].join(""),l={uuid:a,data:t},d=setTimeout((()=>u(new o(`请求远程(${this.rService.config.ip})事件 [${e}] 超时`))),n),c=t=>{t.uuid===a&&(clearTimeout(d),this.rService.socket.removeEventListener(e,c),t.status==s.default.STATUS_OK?i(t.data):t.data.err?u(new o(t.data.err)):u(new o(t.data)))};this.rService.socket.on(e,c),this.rService.emit(e,l)}))}}},2195:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(8264),s=n(521),o=i(n(3204)),u=n(3858),a=i(n(2126)),l=i(n(4470)),d=i(n(1017));class c extends u.UniversalRemoteSubsystem{constructor(){super(),a.default.list("RemoteServiceConfig").forEach((e=>{const t=a.default.load("RemoteServiceConfig",s.RemoteServiceConfig,e),n=new o.default(e,t);this.setInstance(e,n),n.connect()})),0===this.services.size&&this.initConnectLocalhost(""),r.logger.info("远程服务子系统初始化完毕"),r.logger.info(`总计配置节点数: ${this.services.size}`),setInterval((()=>this.connectionStatusCheckTask()),6e4)}registerRemoteService(e){const t=this.newInstance(e);return a.default.store("RemoteServiceConfig",t.uuid,t.config),t.connect(),t}deleteRemoteService(e){this.getInstance(e)&&(this.getInstance(e).disconnect(),this.deleteInstance(e),a.default.delete("RemoteServiceConfig",e))}newInstance(e){const t=new o.default(e.uuid||this.randdomUuid(),new s.RemoteServiceConfig);return this.setInstance(t.uuid,t),this.edit(t.uuid,e),t}edit(e,t){const n=this.getInstance(e);t.remarks&&(n.config.remarks=t.remarks),t.ip&&(n.config.ip=t.ip),t.port&&(n.config.port=t.port),t.apiKey&&(n.config.apiKey=t.apiKey),a.default.store("RemoteServiceConfig",n.uuid,n.config)}async initConnectLocalhost(e){const t="localhost",n=d.default.normalize(d.default.join(process.cwd(),"../daemon/data/Config/global.json"));if(r.logger.info(`正在尝试读取本地守护进程: ${n}`),l.default.existsSync(n)){r.logger.info("检测到本地守护进程，正在自动获取密钥和端口...");const e=JSON.parse(l.default.readFileSync(n,{encoding:"utf-8"})),i=e.key,s=e.port;return r.logger.info("正在自动连接本地守护进程..."),this.registerRemoteService({apiKey:i,port:s,ip:t})}if(e){const n=24444;return r.logger.info("无法自动获取本地守护进程配置文件，已发起连接但可能未经证实..."),this.registerRemoteService({apiKey:e,port:n,ip:t})}r.logger.warn("无法自动获取本地守护进程配置文件，请前往面板手动连接守护进程"),r.logger.warn("前往 https://docs.mcsmanager.com/ 了解更多。"),setTimeout((()=>{if(0===this.services.size)return this.initConnectLocalhost()}),5e3)}count(){let e=0,t=0;return this.services.forEach((n=>{e++,n.available&&t++})),{available:t,total:e}}connectionStatusCheckTask(){var e;null===(e=this.services)||void 0===e||e.forEach((e=>{if(e&&!1===e.available)return r.logger.warn(`检测到守护进程 ${e.config.remarks} ${e.config.ip}:${e.config.port} 状态异常，正在重置并连接`),e.connect()}))}}t.default=new c},6469:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const r=i(n(1490)),s=n(5828),o=n(1677),u=n(8264),a=i(n(2126)),l=n(9728);e.exports=new class{constructor(){this.objects=new Map,a.default.list("User").forEach((e=>{const t=a.default.load("User",o.User,e);this.objects.set(e,t)})),u.logger.info(`面板用户实体数：${this.objects.size}`)}create(e){const t=s.v4().replace(/-/gim,""),n=new o.User;return n.uuid=t,n.registerTime=(new Date).toLocaleString(),this.setInstance(t,n),this.edit(n.uuid,e),a.default.store("User",n.uuid,n),n}edit(e,t){const n=this.getInstance(e);t.userName&&(n.userName=t.userName),null!=t.isInit&&(n.isInit=Boolean(t.isInit)),t.permission&&(n.permission=t.permission),t.registerTime&&(n.registerTime=t.registerTime),t.loginTime&&(n.loginTime=t.loginTime),t.passWord&&(n.passWord=r.default(t.passWord)),t.instances&&this.setUserInstances(e,t.instances),null!=t.apiKey&&(n.apiKey=t.apiKey),a.default.store("User",e,n)}validatePassword(e=""){return!(e.length<9||e.length>36)&&/(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])/.test(e)}checkUser(e){let t=!1;const n=r.default(e.passWord);return this.objects.forEach((i=>{if(i.userName===e.userName&&i.passWord===n)return t=!0})),t}existUserName(e){let t=!1;return this.objects.forEach((n=>{if(n.userName===e)return t=!0})),t}setUserInstances(e,t){const n=this.getInstance(e);t.forEach((e=>{if(!e.serviceUuid||!e.instanceUuid)throw new Error("Type error, The instances of user must is IUserHaveInstance array.")})),n.instances=[],t.forEach((e=>{n.instances.push({instanceUuid:String(e.instanceUuid),serviceUuid:String(e.serviceUuid)})}))}getUserByUserName(e){for(const t of this.objects){const n=t[1];if(n.userName===e)return n}return null}getInstance(e){return this.objects.get(e)}setInstance(e,t){this.objects.set(e,t)}hasInstance(e){return this.objects.has(e)}deleteInstance(e){this.hasInstance(e)&&(this.objects.delete(e),a.default.delete("User",e))}getQueryWrapper(){return new l.QueryWrapper(new l.LocalFileSource(this.objects))}}},4419:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=n(8264),s=n(9857),o=i(n(2195)),u=i(n(5153));class a{constructor(e,t){this.maxSize=e,this.arr=new Array;for(let n=0;n<e;n++)this.arr.push(t)}push(e){this.arr.length<this.maxSize||this.arr.shift(),this.arr.push(e)}getArray(){return this.arr}}t.default=new class{constructor(){this.countMap=new Map,this.systemChart=new a(60,{cpu:0,mem:0}),this.statusChart=new a(60,{value:0,totalInstance:0,runningInstance:0}),this.requestCount=0,setInterval((()=>{const e=s.systemInfo();e?this.systemChart.push({cpu:Number((100*e.cpuUsage).toFixed(1)),mem:Number((100*e.memUsage).toFixed(1))}):this.systemChart.push({cpu:0,mem:0})}),1e4),setInterval((async()=>{const e=new Array;for(const t of o.default.services.entries())try{e.push(await new u.default(t[1]).request("info/overview"))}catch(e){}let t=0,n=0;for(const i of e)i.instance&&(t+=i.instance.total,n+=i.instance.running);this.statusChart.push({value:this.requestCount,totalInstance:t,runningInstance:n}),this.requestCount=0}),1e4)}addRequestCount(){this.requestCount++}getSystemChartArray(){return this.systemChart.getArray()}getStatusChartArray(){return this.statusChart.getArray()}emitCountEvent(e){const t=this.countMap.get(e);t?this.countMap.set(e,t+1):this.countMap.set(e,1)}eventCount(e){return this.countMap.get(e)}emitLogEvent(e,t){const n=(new Date).toLocaleString();r.logger.info(`The object [${t}] triggered the [${e}] event at ${n}`)}}},237:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const r=i(n(2167)),s=(new Date).toLocaleDateString();async function o(){return await r.default.get("http://statistics.mcsmanager.com/",{params:{st:s},timeout:1e4})}setTimeout((async()=>{try{return await o()}catch(e){}}),864e5),o().then((()=>{})).catch((()=>{}))},6547:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.systemConfig=t.saveSystemConfig=t.initSystemConfig=void 0;const r=i(n(3149)),s=i(n(2126));let o=null;t.systemConfig=o,t.initSystemConfig=function(){t.systemConfig=o=s.default.load("SystemConfig",r.default,"config"),o||(t.systemConfig=o=new r.default,s.default.store("SystemConfig","config",o))},t.saveSystemConfig=function(e){s.default.store("SystemConfig","config",e)}},6296:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.specifiedDaemonVersion=t.getVersion=t.initVersionManager=void 0;const u=s(n(4470)),a=o(n(299)),l=n(8264),d="package.json";t.initVersionManager=function(){try{if(a.default.set("version","Unknown"),u.existsSync(d)){const e=JSON.parse(u.readFileSync(d,{encoding:"utf-8"}));e.version&&a.default.set("version",e.version)}}catch(e){l.logger.error("版本检查失败",e)}},t.getVersion=function(){return a.default.get("version","Unknown")},t.specifiedDaemonVersion=function(){var e;try{return null!==(e=JSON.parse(u.readFileSync(d,{encoding:"utf-8"})).daemonVersion)&&void 0!==e?e:"1.0.0"}catch(e){return"1.0.0"}}},1511:e=>{e.exports=require("@koa/router")},2167:e=>{e.exports=require("axios")},4470:e=>{e.exports=require("fs-extra")},1406:e=>{e.exports=require("koa")},5004:e=>{e.exports=require("koa-body")},9511:e=>{e.exports=require("koa-session")},8097:e=>{e.exports=require("koa-static")},8094:e=>{e.exports=require("log4js")},1490:e=>{e.exports=require("md5")},7411:e=>{e.exports=require("os-utils")},8087:e=>{e.exports=require("socket.io-client")},5828:e=>{e.exports=require("uuid")},7147:e=>{e.exports=require("fs")},3685:e=>{e.exports=require("http")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")}},t={};!function n(i){var r=t[i];if(void 0!==r)return r.exports;var s=t[i]={exports:{}};return e[i].call(s.exports,s,s.exports,n),s.exports}(3165)})();