(()=>{"use strict";var e={6672:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(2866);s.initVersionManager();const r=s.getVersion();console.log(`______  _______________________  ___                                         \n___   |/  /_  ____/_  ___/__   |/  /_____ _____________ _______ _____________\n__  /|_/ /_  /    _____ \\__  /|_/ /_  __  /_  __ \\  __  /_  __  /  _ \\_  ___/\n_  /  / / / /___  ____/ /_  /  / / / /_/ /_  / / / /_/ /_  /_/ //  __/  /    \n/_/  /_/  \\____/  /____/ /_/  /_/  \\__,_/ /_/ /_/\\__,_/ _\\__, / \\___//_/     \n                                                        /____/             \n + Released under the GPL-3.0 License\n + Copyright 2022 Suwings\n + Version ${r}\n`);const u=i(n(1406)),o=n(5828),a=i(n(1017)),d=i(n(5004)),l=i(n(9511)),c=i(n(8097)),f=i(n(3685)),g=n(1088),y=n(2472),p=__dirname,_=n(1653);_.initSystemConfig();const m=new u.default;var h,S;m.use(d.default({multipart:!0,parsedMethods:["POST","PUT","DELETE","GET"]})),m.keys=[o.v4()],m.use(l.default({key:o.v4(),maxAge:864e5,overwrite:!0,httpOnly:!0,signed:!0,rolling:!1,renew:!1,secure:!1},m)),m.use((async(e,t)=>{g.logger.info(`${e.ip} ${e.method} - ${e.URL.href}`),await t()})),m.use(y.middleware),m.use(c.default(a.default.join(p,"public"))),n(1832).index(m),process.on("uncaughtException",(function(e){g.logger.error("ERROR (uncaughtException):",e)})),process.on("unhandledRejection",((e,t)=>{g.logger.error("ERROR (unhandledRejection):",e,t)})),h=_.systemConfig.httpPort,S=_.systemConfig.httpIp,f.default.createServer(m.callback()).listen(h,S),g.logger.info("================================"),g.logger.info("控制面板端已启动"),g.logger.info(`访问地址: http://${S||"localhost"}:${h}/`),g.logger.info("项目参考: https://github.com/Suwings/MCSManager"),g.logger.info("关闭此程序请使用 Ctrl+C 快捷键"),g.logger.info("================================")},606:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0});class n{static set(e,t){n.map.set(e,t)}static get(e,t){return n.map.has(e)?n.map.get(e):t}static del(e){return n.map.delete(e)}}t.default=n,n.map=new Map},2242:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.listenMap=new Map}requestForward(e,t){if(this.listenMap.has(t)){const n=this.listenMap.get(t);for(const t of n)if(t.id===e.id)throw new Error(`此 Socket ${e.id} 已经存在于指定实例监听表中`);n.push(e)}else this.listenMap.set(t,[e])}cannelForward(e,t){if(!this.listenMap.has(t))throw new Error(`指定 ${t} 并不存在于监听表中`);const n=this.listenMap.get(t);n.forEach(((t,i)=>{t.id===e.id&&n.splice(i,1)}))}forward(e,t){this.listenMap.get(e).forEach((e=>{e&&e.connected&&e.emit("instance/stdout",t)}))}forwardViaCallback(e,t){this.listenMap.has(e)&&this.listenMap.get(e).forEach((e=>{e&&e.connected&&t(e)}))}hasListenInstance(e){return this.listenMap.has(e)&&this.listenMap.get(e).length>0}}},2296:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.QueryWrapper=t.LocalFileSource=t.MySqlSource=t.QueryMapWrapper=void 0,t.QueryMapWrapper=class{constructor(e){this.map=e}select(e){const t=[];return this.map.forEach((n=>{e(n)&&t.push(n)})),t}page(e,t=1,n=10){const i=(t-1)*n,s=i+n;let r=e.length,u=0;for(;r>0;)r-=n,u++;return{page:t,pageSize:n,maxPage:u,data:e.slice(i,s)}}},t.MySqlSource=class{},t.LocalFileSource=class{constructor(e){this.data=e}selectPage(e,t=1,n=10){const i=[];return this.data.forEach((t=>{for(const n in e){const i=t[n],s=e[n];if("%"==s[0]){if(!i.includes(s.slice(1,s.length-1)))return!1}else if(s!==i)return!1}i.push(t)})),this.page(i,t,n)}page(e,t=1,n=10){const i=(t-1)*n,s=i+n;let r=e.length,u=0;for(;r>0;)r-=n,u++;return{page:t,pageSize:n,maxPage:u,total:e.length,data:e.slice(i,s)}}select(e){return null}update(e,t){}delete(e){}insert(e){}},t.QueryWrapper=class{constructor(e){this.dataSource=e}selectPage(e,t=1,n=10){return this.dataSource.selectPage(e,t,n)}}},1153:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.systemInfo=void 0;const s=i(n(2037)),r=i(n(7411));let u=null;setInterval((()=>{r.default.cpuUsage((e=>{u={cpuUsage:e,totalmem:s.default.totalmem(),freemem:s.default.freemem(),type:s.default.type(),hostname:s.default.hostname(),platform:s.default.platform(),release:s.default.release(),uptime:s.default.uptime(),cwd:process.cwd(),processCpu:process.cpuUsage().system,processMem:process.memoryUsage().rss,memUsage:(s.default.totalmem()-s.default.freemem())/s.default.totalmem()}}))}),1e3),t.systemInfo=function(){return u}},4789:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1017)),r=i(n(4470));class u{store(e,t,n){const i=s.default.join(u.STIRAGE_DATA_PATH,e);r.default.existsSync(i)||r.default.mkdirsSync(i);const o=s.default.join(i,`${t}.json`),a=JSON.stringify(n,null,4);r.default.writeFileSync(o,a,{encoding:"utf-8"})}load(e,t,n){const i=s.default.join(u.STIRAGE_DATA_PATH,e);r.default.existsSync(i)||r.default.mkdirsSync(i);const o=s.default.join(i,`${n}.json`);if(!r.default.existsSync(o))return null;const a=r.default.readFileSync(o,{encoding:"utf-8"}),d=JSON.parse(a),l=new t;for(const e of Object.keys(l))void 0!==d[e]&&(l[e]=d[e]);return l}list(e){const t=s.default.join(u.STIRAGE_DATA_PATH,e);r.default.existsSync(t)||r.default.mkdirsSync(t);const n=r.default.readdirSync(t),i=new Array;return n.forEach((e=>{i.push(e.replace(s.default.extname(e),""))})),i}delete(e,t){const n=s.default.join(u.STIRAGE_DATA_PATH,e,`${t}.json`);r.default.existsSync(n)&&r.default.removeSync(n)}}u.STIRAGE_DATA_PATH=s.default.normalize(s.default.join(process.cwd(),"data")),u.STIRAGE_INDEX_PATH=s.default.normalize(s.default.join(process.cwd(),"data","index")),t.default=new u},3378:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.RemoteServiceConfig=void 0,t.RemoteServiceConfig=class{constructor(){this.ip="",this.port=24444,this.remarks="",this.apiKey="",this.connectOpts={multiplex:!1,reconnectionDelayMax:3e3,timeout:3e3,reconnection:!0,reconnectionAttempts:1e3}}}},5791:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return s(t,e),t},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(n(8087)),a=n(1088),d=u(n(525)),l=u(n(2242));class c{constructor(e,t){this.uuid=null,this.available=!1,this.socket=null,this.instanceStream=new l.default,this.uuid=e,this.config=t}connect(e){if(e&&(this.config.connectOpts=e),this.available&&(a.logger.info(`[${this.uuid}] 用户发起重连已可用状态的远程服务，正在重置连接通道`),this.disconnect()),this.socket&&this.socket.hasListeners("connect"))return a.logger.info(`[${this.uuid}] 用户发起重复连接请求，现进行重置连接配置`),this.refreshReconnect();a.logger.info(`[${this.uuid}] 面板正在尝试连接远程服务 ${this.config.ip}:${this.config.port}`);const t=`ws://${this.config.ip}:${this.config.port}`;this.socket=o.connect(t,e),this.socket.on("connect",(async()=>{a.logger.info(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 已连接`),await this.onConnect()})),this.socket.on("disconnect",(async()=>{a.logger.info(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 已断开`),await this.onDisconnect()})),this.socket.on("connect_error",(async e=>{a.logger.warn(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 连接错误`),await this.onDisconnect()}))}async auth(e){e&&(this.config.apiKey=e);try{return!0===await new d.default(this).request("auth",this.config.apiKey,5e3,!0)?(this.available=!0,a.logger.info(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 验证成功`),!0):(this.available=!1,a.logger.warn(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 验证失败`),!1)}catch(e){return a.logger.warn(`远程服务 [${this.uuid}] [${this.config.ip}:${this.config.port}] 验证错误`),!1}}emit(e,t){return this.socket.emit(e,t)}async onDisconnect(){this.available=!1}async onConnect(){return await this.auth(this.config.apiKey)}disconnect(){this.socket&&(a.logger.info(`[${this.uuid}] [${this.config.ip}:${this.config.port}] Socket 已主动释放连接`),this.socket.removeAllListeners(),this.socket.disconnect(),this.socket.close(),delete this.socket),this.socket=null,this.available=!1}refreshReconnect(){this.disconnect(),this.connect()}}t.default=c,c.STATUS_OK=200,c.STATUS_ERR=500},8415:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.default=class{constructor(){this.httpPort=23333,this.httpIp=null,this.crossDomain=!1,this.gzip=!1,this.maxCompress=1,this.maxDonwload=10,this.zipType=1,this.loginCheckIp=!0}}},2930:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.User=void 0,t.User=class{constructor(){this.uuid="",this.userName="",this.passWord="",this.salt="",this.permission=0,this.registerTime="",this.loginTime="",this.instances=[],this.apiKey=""}}},1832:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.index=void 0;const s=i(n(1511));n(6947),n(9951),n(4447);const r=i(n(8718)),u=i(n(52)),o=i(n(4906)),a=i(n(6188)),d=i(n(8294)),l=i(n(5651)),c=i(n(3908)),f=i(n(8776)),g=i(n(5068)),y=i(n(8168)),p=i(n(9484)),_=i(n(1796)),m=i(n(5785));t.index=function(e){const t=new s.default({prefix:"/api"});t.use(r.default.routes()).use(r.default.allowedMethods()),t.use(c.default.routes()).use(c.default.allowedMethods()),t.use(l.default.routes()).use(l.default.allowedMethods()),t.use(f.default.routes()).use(f.default.allowedMethods()),t.use(g.default.routes()).use(g.default.allowedMethods()),t.use(y.default.routes()).use(y.default.allowedMethods()),t.use(p.default.routes()).use(p.default.allowedMethods()),t.use(o.default.routes()).use(o.default.allowedMethods()),t.use(a.default.routes()).use(a.default.allowedMethods()),t.use(u.default.routes()).use(u.default.allowedMethods()),t.use(_.default.routes()).use(_.default.allowedMethods()),t.use(d.default.routes()).use(d.default.allowedMethods()),t.use(m.default.routes()).use(m.default.allowedMethods()),e.use(t.routes()).use(t.allowedMethods())}},2516:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const s=i(n(606)),r=i(n(6947)),u=n(2386);e.exports=e=>async(t,n)=>{if(t.query.apikey){const i=String(t.query.apikey),s=u.getUuidByApiKey(i);return s&&s.permission>=e.level?await n():function(e){e.status=403,e.body="[Forbidden] API 密钥不正确"}(t)}if(!1!==e.token){if(!u.isAjax(t))return function(e){e.status=403,e.body="[Forbidden] 无法找到请求头 x-requested-with: xmlhttprequest"}(t);if(t.query.token!==t.session.token)return function(e){e.status=403,e.body="[Forbidden] 令牌(Token)验证失败，拒绝访问"}(t)}if(isNaN(parseInt(e.level)))return await n();if(!0===t.session.login&&t.session.uuid&&t.session.userName){const i=r.default.getInstance(t.session.uuid);if(i&&i.permission>=e.level)return await n()}return s.default.set(u.ILLEGAL_ACCESS_KEY,s.default.get(u.ILLEGAL_ACCESS_KEY,0)+1),function(e){e.status=403,e.body="[Forbidden] 权限不足"}(t)}},2472:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.middleware=void 0;const s=n(2781),r=i(n(9951)),u=n(1653);t.middleware=async function(e,t){e.url.startsWith("/api/")&&r.default.addRequestCount();try{await t()}catch(t){e.body=t}if(u.systemConfig.crossDomain&&(e.response.set("Access-Control-Allow-Origin","*"),e.response.set("Access-Control-Allow-Methods","PUT, POST, GET, DELETE, OPTIONS"),e.response.set("Access-Control-Allow-Headers","Content-Type, Content-Length, Authorization, Accept, X-Requested-With")),e.cookies.set("MCSManager","Copyright 2021 Suwings"),e.response.set("X-Powered-By","MCSManager"),e.body instanceof Error){const t=e.body;return e.status=500,void(e.body=JSON.stringify({status:e.status,data:t.message,time:(new Date).getTime()}))}if(!(e.body instanceof s.Stream)){if(404==e.status)return e.status=404,void(e.body=JSON.stringify({status:e.status,data:"[404] Not Found",time:(new Date).getTime()}));if("string"!=typeof e.body){if(null===e.body||!1===e.body||void 0===e.body)return e.status=500,void(e.body=JSON.stringify({status:500,data:e.body||null,time:(new Date).getTime()}));200!=e.status||(e.body=JSON.stringify({status:e.status,data:e.body,time:(new Date).getTime()}))}else{const t=e.status,n=e.body;e.body=JSON.stringify({status:t,data:n,time:(new Date).getTime()})}}}},5290:e=>{function t(e,t){if(e){for(const n in t){const i=t[n];if(null==e[n]||""===e[n])return!1;if(i!==Number)if(i!==String)if(i!==Date){if(i===Array&&!(e[n]instanceof Array)){const t=JSON.parse(e[n]);if(!(t instanceof Array))return!1;e[n]=t}if(i===Object&&!e[n])return!1}else{const t=new Date(e[n]).toString();if("Invalid Date"==t||null==t)return!1;e[n]=new Date(e[n])}else e[n]=String(e[n]);else if(e[n]=Number(e[n]),isNaN(e[n]))return!1}return!0}return!1}e.exports=function(e){return async(n,i)=>{try{let s=!0;return e.params&&!t(n.params,e.params)&&(s=!1),e.query&&!t(n.query,e.query)&&(s=!1),e.body&&!t(n.request.body,e.body)&&(s=!1),s?await i():function(e){e.status=400,e.body="错误请求：请求参数不正确"}(n)}catch(e){const t=e;n.status=500,n.body=`${t.message}`}}}},9484:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(5290)),o=n(2386),a=i(n(6947)),d=new s.default({prefix:"/auth"});d.post("/",r.default({level:10}),u.default({body:{username:String,password:String,permission:Number}}),(async e=>{const t=String(e.request.body.username),n=String(e.request.body.password),i=Number(e.request.body.permission);if(t.length<2||t.length>18)throw new Error("错误的用户名长度规则");if(n.length<6||n.length>18)throw new Error("错误的密码长度规则");if(a.default.existUserName(t))throw new Error("用户名已经被占用");const s=o.register(e,t,n,i);e.body=s})),d.del("/",r.default({level:10}),(async e=>{const t=e.request.body;try{for(const e of t)a.default.deleteInstance(e);e.body=!0}catch(t){e.throw(500,"无法完成用户数据删除")}})),d.get("/search",r.default({level:10}),u.default({query:{page:Number,page_size:Number}}),(async e=>{const t=e.query.userName,n=Number(e.query.page),i=Number(e.query.page_size),s={};t&&(s.userName=`%${t}%`);let r=a.default.getQueryWrapper().selectPage(s,n,i);r=JSON.parse(JSON.stringify(r)),r.data.forEach((e=>{delete e.passWord,delete e.salt})),e.body=r})),t.default=d},5785:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(5290)),o=i(n(4447)),a=i(n(525)),d=new s.default({prefix:"/environment"});d.get("/image",r.default({level:10}),u.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=o.default.getInstance(t),i=await new a.default(n).request("environment/images",{});e.body=i}catch(t){e.body=t}})),d.post("/image",r.default({level:10}),u.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=e.request.body,i=o.default.getInstance(t),s=await new a.default(i).request("environment/new_image",n);e.body=s}catch(t){e.body=t}})),d.delete("/image",r.default({level:10}),u.default({query:{remote_uuid:String,imageId:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.imageId),i=o.default.getInstance(t),s=await new a.default(i).request("environment/del_image",{imageId:n});e.body=s}catch(t){e.body=t}})),d.get("/containers",r.default({level:10}),u.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=o.default.getInstance(t),i=await new a.default(n).request("environment/containers",{});e.body=i}catch(t){e.body=t}})),d.get("/progress",r.default({level:10}),u.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=o.default.getInstance(t),i=await new a.default(n).request("environment/progress",{});e.body=i}catch(t){e.body=t}})),t.default=d},5651:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(5290)),o=i(n(4447)),a=i(n(525)),d=n(9107),l=n(7534),c=new s.default({prefix:"/instance"});c.get("/",r.default({level:10}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=o.default.getInstance(t),s=await new a.default(i).request("instance/detail",{instanceUuid:n});e.body=s}catch(t){e.body=t}})),c.post("/",r.default({level:10}),u.default({query:{remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=e.request.body,i=o.default.getInstance(t),s=await new a.default(i).request("instance/new",n);e.body=s}catch(t){e.body=t}})),c.post("/upload",r.default({level:10}),u.default({query:{remote_uuid:String,upload_dir:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=e.request.body,i=o.default.getInstance(t),s=(await new a.default(i).request("instance/new",n)).instanceUuid;if(!s)throw new Error("创建实例失败");const r=`${i.config.ip}:${i.config.port}`,u=l.timeUuid();await new a.default(i).request("passport/register",{name:"upload",password:u,parameter:{uploadDir:".",instanceUuid:s}}),e.body={instanceUuid:s,password:u,addr:r}}catch(t){e.body=t}})),c.put("/",r.default({level:10}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body,s=o.default.getInstance(t),r=await new a.default(s).request("instance/update",{instanceUuid:n,config:i});e.body=r}catch(t){e.body=t}})),c.delete("/",r.default({level:10}),u.default({query:{remote_uuid:String},body:{uuids:Object,deleteFile:Boolean}}),(async e=>{try{const t=String(e.query.remote_uuid),n=e.request.body.uuids,i=e.request.body.deleteFile,s=o.default.getInstance(t),r=await new a.default(s).request("instance/delete",{instanceUuids:n,deleteFile:i});e.body=r}catch(t){e.body=t}})),c.post("/multi_open",r.default({level:10}),(async e=>{try{const t=e.request.body;d.multiOperationForwarding(t,(async(e,t)=>{const n=o.default.getInstance(e);new a.default(n).request("instance/open",{instanceUuids:t}).catch((()=>{}))})),e.body=!0}catch(t){e.body=t}})),c.post("/multi_stop",r.default({level:10}),(async e=>{try{const t=e.request.body;d.multiOperationForwarding(t,(async(e,t)=>{const n=o.default.getInstance(e);new a.default(n).request("instance/stop",{instanceUuids:t}).catch((()=>{}))})),e.body=!0}catch(t){e.body=t}})),c.post("/multi_kill",r.default({level:10}),(async e=>{try{const t=e.request.body;d.multiOperationForwarding(t,(async(e,t)=>{const n=o.default.getInstance(e);new a.default(n).request("instance/kill",{instanceUuids:t}).catch((e=>{}))})),e.body=!0}catch(t){e.body=t}})),t.default=c},8718:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(4447)),o=i(n(9951)),a=i(n(525)),d=i(n(2037)),l=n(1153),c=n(2866),f=i(n(606)),g=n(2386),y=new s.default({prefix:"/overview"});y.get("/",r.default({level:10,token:!1}),(async e=>{const t=new Array;for(const e of u.default.services.entries()){const n=e[1];let i={};try{i=await new a.default(n).request("info/overview")}catch(e){}i.uuid=n.uuid,i.ip=n.config.ip,i.port=n.config.port,i.available=n.available,i.remarks=n.config.remarks,t.push(i)}const n=l.systemInfo(),i={version:c.getVersion(),process:{cpu:n.processCpu,memory:n.processMem,cwd:n.cwd},record:{logined:f.default.get(g.LOGIN_COUNT,0),illegalAccess:f.default.get(g.ILLEGAL_ACCESS_KEY,0),banips:f.default.get(g.BAN_IP_COUNT,0),loginFailed:f.default.get(g.LOGIN_FAILED_COUNT_KEY,0)},system:{user:d.default.userInfo(),time:(new Date).toLocaleString(),totalmem:d.default.totalmem(),freemem:d.default.freemem(),type:d.default.type(),version:d.default.version(),node:process.version,hostname:d.default.hostname(),loadavg:d.default.loadavg(),platform:d.default.platform(),release:d.default.release(),uptime:d.default.uptime(),cpu:n.cpuUsage},chart:{system:o.default.getSystemChartArray(),request:o.default.getStatusChartArray()},remoteCount:u.default.count(),remote:t};e.body=i})),t.default=y},8776:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(5290)),o=i(n(4447)),a=i(n(525)),d=new s.default({prefix:"/service"});d.get("/remote_services_list",r.default({level:10}),(async e=>{const t=new Array;for(const e of o.default.services.entries()){const n=e[1];t.push({uuid:n.uuid,ip:n.config.ip,port:n.config.port,available:n.available,remarks:n.config.remarks})}e.body=t})),d.get("/remote_service_instances",r.default({level:10}),u.default({query:{remote_uuid:String,page:Number,page_size:Number}}),(async e=>{const t=String(e.query.remote_uuid),n=Number(e.query.page),i=Number(e.query.page_size),s=e.query.instance_name,r=o.default.getInstance(t),u=await new a.default(r).request("instance/select",{page:n,pageSize:i,condition:{instanceName:s}});e.body=u})),d.get("/remote_services_system",r.default({level:10}),(async e=>{const t=new Array;for(const e of o.default.services.entries()){const n=e[1];let i=null;try{i=await new a.default(n).request("info/overview")}catch(e){continue}t.push(i)}e.body=t})),d.get("/remote_services",r.default({level:10}),(async e=>{const t=new Array;for(const e of o.default.services.entries()){const n=e[1];let i=[];try{i=await new a.default(n).request("instance/overview")}catch(e){}t.push({uuid:n.uuid,ip:n.config.ip,port:n.config.port,available:n.available,instances:i})}e.body=t})),d.post("/remote_service",r.default({level:10}),u.default({body:{apiKey:String,port:Number,ip:String,remarks:String}}),(async e=>{const t=e.request.body,n=o.default.registerRemoteService({apiKey:t.apiKey,port:t.port,ip:t.ip,remarks:t.remarks||""});e.body=n.uuid})),d.put("/remote_service",r.default({level:10}),u.default({query:{uuid:String}}),(async e=>{const t=String(e.request.query.uuid),n=e.request.body;if(!o.default.services.has(t))throw new Error("实例不存在");await o.default.edit(t,{port:n.port,ip:n.ip,apiKey:n.apiKey,remarks:n.remarks}),e.body=!0})),d.delete("/remote_service",r.default({level:10}),u.default({query:{uuid:String}}),(async e=>{const t=String(e.request.query.uuid);if(!o.default.services.has(t))throw new Error("实例不存在");await o.default.deleteRemoteService(t),e.body=!0})),d.get("/link_remote_service",r.default({level:10}),u.default({query:{uuid:String}}),(async e=>{const t=String(e.request.query.uuid);if(!o.default.services.has(t))throw new Error("实例不存在");try{o.default.getInstance(t).connect(),e.body=!0}catch(t){e.body=t}})),t.default=d},8294:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(5290)),o=n(1653),a=new s.default({prefix:"/overview"});a.get("/setting",r.default({level:10}),(async e=>{e.body=o.systemConfig})),a.put("/setting",u.default({body:{}}),r.default({level:10}),(async e=>{const t=e.request.body;if(t)return null!=t.httpIp&&(o.systemConfig.httpIp=t.httpIp),null!=t.httpPort&&(o.systemConfig.httpPort=t.httpPort),null!=t.crossDomain&&(o.systemConfig.crossDomain=t.crossDomain),null!=t.gzip&&(o.systemConfig.gzip=t.gzip),null!=t.maxCompress&&(o.systemConfig.maxCompress=t.maxCompress),null!=t.maxDonwload&&(o.systemConfig.maxDonwload=t.maxDonwload),null!=t.zipType&&(o.systemConfig.zipType=t.zipType),null!=t.loginCheckIp&&(o.systemConfig.loginCheckIp=t.loginCheckIp),o.saveSystemConfig(o.systemConfig),void(e.body="OK");e.body=new Error("错误的配置方式")})),t.default=a},52:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(6947)),o=new s.default({prefix:"/auth"});o.put("/",r.default({level:10}),(async e=>{const{uuid:t,config:n}=e.request.body;try{u.default.edit(t,n),e.body=!0}catch(t){e.throw(500,t.message)}})),o.get("/overview",r.default({level:10}),(async e=>{const t=[];u.default.objects.forEach((e=>{t.push({uuid:e.uuid,userName:e.userName,permission:e.permission,instances:e.instances,loginTime:e.loginTime,registerTime:e.loginTime})})),e.body=t})),t.default=o},8168:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(5290)),o=n(2386),a=i(n(4447)),d=i(n(525)),l=n(8299),c=new s.default({prefix:"/protected_instance"});c.use((async(e,t)=>{const n=String(e.query.uuid),i=String(e.query.remote_uuid),s=o.getUserUuid(e);l.isHaveInstanceByUuid(s,i,n)?await t():(e.status=403,e.body="[Forbidden] [中间件] 参数不正确或非法访问实例")})),c.put("/low_permission",r.default({level:1}),u.default({query:{uuid:String,remote_uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body,s={ie:String(i.ie),oe:String(i.oe),stopCommand:String(i.stopCommand)},r=a.default.getInstance(t),u=await new d.default(r).request("instance/update",{instanceUuid:n,config:s});e.body=u}catch(t){e.body=t}})),t.default=c},5068:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(5290)),o=i(n(4447)),a=i(n(525)),d=n(7534),l=n(2386),c=n(8299),f=new s.default({prefix:"/files"});f.use((async(e,t)=>{const n=String(e.query.uuid),i=String(e.query.remote_uuid),s=l.getUserUuid(e);c.isHaveInstanceByUuid(s,i,n)?await t():(e.status=403,e.body="[Forbidden] [中间件] 参数不正确或非法访问实例")})),f.get("/list",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String,target:String}}),(async e=>{try{const t=String(e.query.target),n=String(e.query.remote_uuid),i=String(e.query.uuid),s=o.default.getInstance(n),r=await new a.default(s).request("file/list",{instanceUuid:i,target:t});e.body=r}catch(t){e.body=t}})),f.post("/mkdir",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String},body:{target:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.request.body.target),s=o.default.getInstance(t),r=await new a.default(s).request("file/mkdir",{target:i,instanceUuid:n});e.body=r}catch(t){e.body=t}})),f.put("/",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String},body:{target:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.request.body.target),s=e.request.body.text,r=o.default.getInstance(t),u=await new a.default(r).request("file/edit",{instanceUuid:n,target:i,text:s});e.body=u}catch(t){e.body=t}})),f.post("/copy",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String},body:{targets:Array}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body.targets,s=o.default.getInstance(t),r=await new a.default(s).request("file/copy",{instanceUuid:n,targets:i});e.body=r}catch(t){e.body=t}})),f.put("/move",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String},body:{targets:Array}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body.targets,s=o.default.getInstance(t),r=await new a.default(s).request("file/move",{instanceUuid:n,targets:i});e.body=r}catch(t){e.body=t}})),f.delete("/",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String},body:{targets:Object}}),(async e=>{try{const t=String(e.query.remote_uuid),n=e.query.uuid,i=e.request.body.targets,s=o.default.getInstance(t),r=await new a.default(s).request("file/delete",{instanceUuid:n,targets:i});e.body=r}catch(t){e.body=t}})),f.post("/compress",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String},body:{source:String,targets:Object,type:Number}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.request.body.source),s=e.request.body.targets,r=Number(e.request.body.type),u=o.default.getInstance(t);new a.default(u).request("file/compress",{instanceUuid:n,targets:s,source:i,type:r}),e.body=!0}catch(t){e.body=t}})),f.all("/download",r.default({level:1}),u.default({query:{uuid:String,remote_uuid:String,file_name:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.file_name),s=o.default.getInstance(t),r=`${s.config.ip}:${s.config.port}`,u=d.timeUuid();await new a.default(s).request("passport/register",{name:"download",password:u,parameter:{fileName:i,instanceUuid:n}}),e.body={password:u,addr:r}}catch(t){e.body=t}})),f.all("/upload",r.default({level:1}),u.default({query:{uuid:String,remote_uuid:String,upload_dir:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.upload_dir),s=o.default.getInstance(t),r=`${s.config.ip}:${s.config.port}`,u=d.timeUuid();await new a.default(s).request("passport/register",{name:"upload",password:u,parameter:{uploadDir:i,instanceUuid:n}}),e.body={password:u,addr:r}}catch(t){e.body=t}})),t.default=f},6188:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=n(2386),o=i(n(6947)),a=n(2386),d=i(n(4447)),l=i(n(525)),c=n(8299),f=i(n(5290)),g=n(5828),y=new s.default({prefix:"/auth"});y.get("/token",r.default({level:1,token:!1}),(async e=>{if(!a.isAjax(e))throw new Error("The request is not an Ajax request.");e.body=a.getToken(e)})),y.get("/",r.default({level:1,token:!1}),(async e=>{let t=u.getUserUuid(e);const n=e.query.advanced;if(c.isTopPermissionByUuid(t)&&e.query.uuid&&(t=String(e.query.uuid)),a.isAjax(e)){const i=o.default.getInstance(t);if(!i)throw new Error("此用户UID不存在");let s=[];if(n){const e=i.instances;for(const t of e){const e=d.default.getInstance(t.serviceUuid);if(e)try{let n=await new l.default(e).request("instance/section",{instanceUuids:[t.instanceUuid]});n=n[0],s.push({hostIp:`${e.config.ip}:${e.config.port}`,remarks:e.config.remarks,instanceUuid:n.instanceUuid,serviceUuid:e.uuid,status:n.status,nickname:n.config.nickname,ie:n.config.ie,oe:n.config.oe,endTime:n.config.endTime,lastDatetime:n.config.lastDatetime,stopCommand:n.config.stopCommand})}catch(n){s.push({hostIp:`${e.config.ip}:${e.config.port}`,instanceUuid:t.instanceUuid,serviceUuid:t.serviceUuid,status:-1,nickname:"--"})}else s.push({hostIp:"-- Unknown --",instanceUuid:t.instanceUuid,serviceUuid:t.serviceUuid,status:-1,nickname:"--",remarks:"--"})}}else s=i.instances;e.body={uuid:i.uuid,userName:i.userName,loginTime:i.loginTime,registerTime:i.registerTime,instances:s,permission:i.permission,token:a.getToken(e),apiKey:i.apiKey}}})),y.put("/update",r.default({level:1}),f.default({body:{}}),(async e=>{const t=u.getUserUuid(e);if(t){const n=e.request.body,i=n.userName,s=n.passWord;if(i&&(i.length<2||i.length>18))throw new Error("错误的用户名长度规则");if(s&&(s.length<2||s.length>18))throw new Error("错误的密码长度规则");if(o.default.existUserName(i))throw new Error("用户名已经被占用");o.default.edit(t,{passWord:s,userName:i}),e.body=!0}})),y.put("/api",r.default({level:1}),f.default({body:{}}),(async e=>{const t=u.getUserUuid(e),n=e.request.body.enable,i=o.default.getInstance(t);let s="";try{i&&(n?(s=g.v4().replace(/-/gim,""),o.default.edit(t,{apiKey:s})):o.default.edit(t,{apiKey:""})),e.body=s}catch(t){e.body=t}})),t.default=y},1796:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(5290)),o=i(n(4447)),a=i(n(525)),d=n(2386),l=n(8299),c=new s.default({prefix:"/protected_schedule"});c.use((async(e,t)=>{const n=String(e.query.uuid),i=String(e.query.remote_uuid),s=d.getUserUuid(e);l.isHaveInstanceByUuid(s,i,n)?await t():(e.status=403,e.body="[Forbidden] [中间件] 参数不正确或非法访问实例")})),c.get("/",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=await new a.default(o.default.getInstance(t)).request("schedule/list",{instanceUuid:n});e.body=i}catch(t){e.body=t}})),c.post("/",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String},body:{name:String,count:Number,time:String,action:String,type:Number}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body;e.body=await new a.default(o.default.getInstance(t)).request("schedule/register",{instanceUuid:n,name:String(i.name),count:Number(i.count),time:String(i.time),action:String(i.action),payload:String(i.payload),type:Number(i.type)})}catch(t){e.body=t}})),c.delete("/",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.task_name);e.body=await new a.default(o.default.getInstance(t)).request("schedule/delete",{instanceUuid:n,name:i})}catch(t){e.body=t}})),t.default=c},3908:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(2516)),u=i(n(5290)),o=i(n(4447)),a=i(n(525)),d=n(7534),l=n(2386),c=n(8299),f=new s.default({prefix:"/protected_instance"});f.use((async(e,t)=>{const n=String(e.query.uuid),i=String(e.query.remote_uuid),s=l.getUserUuid(e);c.isHaveInstanceByUuid(s,i,n)?await t():(e.status=403,e.body="[Forbidden] [中间件] 参数不正确或非法访问实例")})),f.all("/open",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=o.default.getInstance(t),s=await new a.default(i).request("instance/open",{instanceUuids:[n]});e.body=s}catch(t){e.body=t}})),f.all("/stop",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=o.default.getInstance(t),s=await new a.default(i).request("instance/stop",{instanceUuids:[n]});e.body=s}catch(t){e.body=t}})),f.all("/command",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String,command:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.command),s=o.default.getInstance(t),r=await new a.default(s).request("instance/command",{instanceUuid:n,command:i});e.body=r}catch(t){e.body=t}})),f.all("/restart",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=o.default.getInstance(t),s=await new a.default(i).request("instance/restart",{instanceUuids:[n]});e.body=s}catch(t){e.body=t}})),f.all("/kill",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=o.default.getInstance(t),s=await new a.default(i).request("instance/kill",{instanceUuids:[n]});e.body=s}catch(t){e.body=t}})),f.post("/stream_channel",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=o.default.getInstance(t),s=`${i.config.ip}:${i.config.port}`,r=d.timeUuid();await new a.default(i).request("passport/register",{name:"stream_channel",password:r,parameter:{instanceUuid:n}}),e.body={password:r,addr:s}}catch(t){e.body=t}})),f.post("/process_config/list",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body.files,s=o.default.getInstance(t),r=await new a.default(s).request("instance/process_config/list",{instanceUuid:n,files:i});e.body=r}catch(t){e.body=t}})),f.get("/process_config/file",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String,fileName:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.fileName),s=String(e.query.type),r=o.default.getInstance(t),u=await new a.default(r).request("instance/process_config/file",{instanceUuid:n,fileName:i,config:null,type:s});e.body=u}catch(t){e.body=t}})),f.put("/process_config/file",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String,fileName:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=String(e.query.fileName),s=String(e.query.type),r=e.request.body,u=o.default.getInstance(t),d=await new a.default(u).request("instance/process_config/file",{instanceUuid:n,fileName:i,config:r,type:s});e.body=d}catch(t){e.body=t}})),f.put("/instance_update",r.default({level:1}),u.default({query:{uuid:String,remote_uuid:String},body:{pingConfig:Object,eventTask:Object}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=e.request.body,s={ip:i.pingConfig.ip,port:i.pingConfig.port,type:i.pingConfig.type},r={autoStart:i.eventTask.autoStart,autoRestart:i.eventTask.autoRestart},u=o.default.getInstance(t),d=await new a.default(u).request("instance/update",{instanceUuid:n,config:{pingConfig:null!=s.ip?s:null,eventTask:null!=r.autoStart?r:null}});e.body=d}catch(t){e.body=t}})),f.get("/outputlog",r.default({level:1}),u.default({query:{remote_uuid:String,uuid:String}}),(async e=>{try{const t=String(e.query.remote_uuid),n=String(e.query.uuid),i=o.default.getInstance(t),s=await new a.default(i).request("instance/outputlog",{instanceUuid:n});e.body=s}catch(t){e.body=t}})),t.default=f},4906:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=i(n(1511)),r=i(n(5290)),u=i(n(2516)),o=n(2386),a=new s.default({prefix:"/auth"});a.post("/login",u.default({token:!1,level:null}),r.default({body:{username:String,password:String}}),(async e=>{const t=String(e.request.body.username),n=String(e.request.body.password);if(!o.checkBanIp(e))throw new Error("身份验证次数过多，您的 IP 地址已被锁定 10 分钟");if(o.check(e))return e.body="Logined";if(!o.login(e,t,n))throw new Error("账号或密码错误");e.body=!0})),a.get("/logout",u.default({token:!1,level:null}),(async e=>{o.logout(e),e.body=!0})),t.default=a},5246:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.UniversalRemoteSubsystem=void 0;const i=n(5828);t.UniversalRemoteSubsystem=class{constructor(){this.services=new Map}setInstance(e,t){if(this.services.get(e))throw new Error("Instance already exists");this.services.set(e,t)}getInstance(e){return this.services.get(e)}deleteInstance(e){return this.services.delete(e)}randdomUuid(){return i.v4().replace(/-/gim,"")}}},9107:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.multiOperationForwarding=void 0,t.multiOperationForwarding=function(e,t){const n=new Map;for(const t of e){const e=t.serviceUuid,i=t.instanceUuid;n.has(e)?n.get(e).push(i):n.set(e,[i])}for(const e of n)t(e[0],e[1])}},1088:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.fullLocalTime=t.fullTime=t.logger=void 0;const s=i(n(8094));s.default.configure({appenders:{out:{type:"stdout",layout:{type:"pattern",pattern:"[%d{MM/dd hh:mm:ss}] [%[%p%]] %m"}},app:{type:"file",filename:"logs/current.log",layout:{type:"pattern",pattern:"%d %p %m"}}},categories:{default:{appenders:["out","app"],level:"info"}}});const r=s.default.getLogger("default");t.logger=r,t.fullTime=function(){const e=new Date;return`${e.getFullYear()}/${e.getMonth()}/${e.getDate()}`},t.fullLocalTime=function(){return(new Date).toLocaleTimeString()}},2386:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getApiKey=t.isApiRequest=t.getUuidByApiKey=t.checkBanIp=t.isAjax=t.getToken=t.getUserUuid=t.getUserNameBySession=t.register=t.logout=t.check=t.login=t.LOGIN_FAILED_COUNT_KEY=t.LOGIN_COUNT=t.ILLEGAL_ACCESS_KEY=t.LOGIN_FAILED_KEY=t.BAN_IP_COUNT=void 0;const s=i(n(6947)),r=n(7534),u=i(n(606)),o=n(1653);function a(e){const t=s.default.getQueryWrapper().selectPage({apiKey:e},1,1);return 1===t.total?t.data[0]:null}function d(e){return!!e.query.apikey}function l(e){return String(e.query.apikey)}t.BAN_IP_COUNT="banip",t.LOGIN_FAILED_KEY="loginFailed",t.ILLEGAL_ACCESS_KEY="illegalAccess",t.LOGIN_COUNT="loginCount",t.LOGIN_FAILED_COUNT_KEY="loginFailedCount",t.login=function(e,n,i){if(u.default.set(t.LOGIN_COUNT,u.default.get(t.LOGIN_COUNT,0)+1),s.default.checkUser({userName:n,passWord:i})){delete u.default.get(t.LOGIN_FAILED_KEY)[e.socket.remoteAddress];const i=s.default.getUserByUserName(n);return i.loginTime=(new Date).toLocaleString(),e.session.login=!0,e.session.userName=n,e.session.uuid=i.uuid,e.session.token=r.timeUuid(),e.session.save(),e.session.token}return u.default.set(t.LOGIN_FAILED_COUNT_KEY,u.default.get(t.LOGIN_FAILED_COUNT_KEY,0)+1),e.session.login=null,e.session.token=null,e.session.save(),null},t.check=function(e){return!!(e.session.login&&e.session.userName&&e.session.token)},t.logout=function(e){return e.session.login=null,e.session.userName=null,e.session.uuid=null,e.session.token=null,e.session.save(),!0},t.register=function(e,t,n,i){let r=!0;return s.default.objects.forEach((e=>{e&&e.userName==t&&(r=!1)})),!!r&&(s.default.create({userName:t,passWord:n,permission:i}),!0)},t.getUserNameBySession=function(e){if(d(e)){const t=a(l(e));return t?t.userName:null}return e.session.userName},t.getUserUuid=function(e){if(d(e)){const t=a(l(e));return t?t.uuid:null}return e.session.uuid},t.getToken=function(e){return e.session.token},t.isAjax=function(e){return e.header["x-requested-with"]&&"xmlhttprequest"===e.header["x-requested-with"].toString().toLocaleLowerCase()},t.checkBanIp=function(e){u.default.map.has(t.LOGIN_FAILED_KEY)||u.default.set(t.LOGIN_FAILED_KEY,{});const n=u.default.get(t.LOGIN_FAILED_KEY),i=e.socket.remoteAddress;return n[i]>10&&!0===o.systemConfig.loginCheckIp?(999!=n[i]&&(u.default.set(t.BAN_IP_COUNT,u.default.get(t.BAN_IP_COUNT,0)+1),setTimeout((()=>{delete n[i],u.default.set(t.BAN_IP_COUNT,u.default.get(t.BAN_IP_COUNT,1)-1)}),6e5)),n[i]=999,!1):(isNaN(Number(n[i]))?n[i]=1:n[i]=Number(n[i])+1,!0)},t.getUuidByApiKey=a,t.isApiRequest=d,t.getApiKey=l},7534:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.timeUuid=void 0;const i=n(5828);t.timeUuid=function(){let e=i.v4().replace(/-/gim,"");return e+=(new Date).getTime()+"",e}},8299:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.isHaveInstanceByUuid=t.isTopPermissionByUuid=t.isTopPermission=t.isHaveInstance=void 0;const s=i(n(6947));function r(e,t,n){if(u(e))return!0;if(e&&e.instances)for(const i of e.instances)if(t===i.serviceUuid&&n===i.instanceUuid)return!0;return!1}function u(e){return!!e&&e.permission>=10}t.isHaveInstance=r,t.isTopPermission=u,t.isTopPermissionByUuid=function(e){return u(s.default.getInstance(e))},t.isHaveInstanceByUuid=function(e,t,n){return r(s.default.getInstance(e),t,n)}},525:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(5828),r=i(n(5791));class u extends Error{constructor(e){super(e)}}t.default=class{constructor(e){if(this.rService=e,!this.rService||!this.rService.socket)throw new Error("Unable to complete initialization, remote service does not exist.")}async request(e,t,n=6e3,i=!1){if(!this.rService.socket)throw new Error("The Socket must is SocketIOClient.Socket, Not null.");if(!this.rService.available&&!i)throw new Error("远程服务状态不可用，建议尝试重连远程服务或检查配置");if(!this.rService.socket.connected&&!i)throw new Error("远程服务连接不可用，无法发送数据");return new Promise(((i,o)=>{const a=[s.v4(),(new Date).getTime()].join(""),d={uuid:a,data:t},l=setTimeout((()=>o(new u(`请求远程(${this.rService.config.ip})事件 [${e}] 超时`))),n),c=t=>{t.uuid===a&&(clearTimeout(l),this.rService.socket.removeEventListener(e,c),t.status==r.default.STATUS_OK?i(t.data):t.data.err?o(new u(t.data.err)):o(new u(t.data)))};this.rService.socket.on(e,c),this.rService.emit(e,d)}))}}},4447:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(1088),r=n(3378),u=i(n(5791)),o=n(5246),a=i(n(4789)),d=i(n(4470)),l=i(n(1017));class c extends o.UniversalRemoteSubsystem{constructor(){super(),a.default.list("RemoteServiceConfig").forEach((e=>{const t=a.default.load("RemoteServiceConfig",r.RemoteServiceConfig,e),n=new u.default(e,t);this.setInstance(e,n),n.connect()})),0===this.services.size&&this.initConnectLocalhost(""),s.logger.info("远程服务子系统初始化完毕"),s.logger.info(`总计配置节点数: ${this.services.size}`)}registerRemoteService(e){const t=this.newInstance(e);return a.default.store("RemoteServiceConfig",t.uuid,t.config),t.connect(),t}deleteRemoteService(e){this.getInstance(e)&&(this.getInstance(e).disconnect(),this.deleteInstance(e),a.default.delete("RemoteServiceConfig",e))}newInstance(e){const t=new u.default(e.uuid||this.randdomUuid(),new r.RemoteServiceConfig);return this.setInstance(t.uuid,t),this.edit(t.uuid,e),t}edit(e,t){const n=this.getInstance(e);t.remarks&&(n.config.remarks=t.remarks),t.ip&&(n.config.ip=t.ip),t.port&&(n.config.port=t.port),t.apiKey&&(n.config.apiKey=t.apiKey),a.default.store("RemoteServiceConfig",n.uuid,n.config)}async initConnectLocalhost(e){const t="localhost",n=l.default.normalize(l.default.join(process.cwd(),"../daemon/data/Config/global.json"));if(s.logger.info(`正在尝试读取本地守护进程: ${n}`),d.default.existsSync(n)){s.logger.info("检测到本地守护进程，正在自动获取密钥和端口...");const e=JSON.parse(d.default.readFileSync(n,{encoding:"utf-8"})),i=e.key,r=e.port;return s.logger.info("正在自动连接本地守护进程..."),this.registerRemoteService({apiKey:i,port:r,ip:t})}if(e){const n=24444;return s.logger.info("无法自动获取本地守护进程配置文件，已发起连接但可能未经证实..."),this.registerRemoteService({apiKey:e,port:n,ip:t})}s.logger.info("无法自动获取本地守护进程配置文件，请手动连接守护进程")}count(){let e=0,t=0;return this.services.forEach((n=>{e++,n.available&&t++})),{available:t,total:e}}}t.default=new c},6947:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};const s=i(n(1490)),r=n(5828),u=n(2930),o=n(1088),a=i(n(4789)),d=n(2296);e.exports=new class{constructor(){this.objects=new Map,a.default.list("User").forEach((e=>{const t=a.default.load("User",u.User,e);this.objects.set(e,t)})),o.logger.info("用户系统初始化完毕"),o.logger.info(`用户数：${this.objects.size}`),this.objects.size<=0&&(o.logger.info("检测到用户数量等于0，正在生成新用户"),this.create({userName:"root",passWord:"123456",permission:10,instances:[]}))}create(e){const t=r.v4().replace(/-/gim,""),n=new u.User;return n.uuid=t,n.registerTime=(new Date).toLocaleString(),this.setInstance(t,n),this.edit(n.uuid,e),a.default.store("User",n.uuid,n),n}edit(e,t){const n=this.getInstance(e);t.userName&&(n.userName=t.userName),t.permission&&(n.permission=t.permission),t.registerTime&&(n.registerTime=t.registerTime),t.loginTime&&(n.loginTime=t.loginTime),t.passWord&&(n.passWord=s.default(t.passWord)),t.instances&&this.setUserInstances(e,t.instances),null!=t.apiKey&&(n.apiKey=t.apiKey),a.default.store("User",e,n)}checkUser(e){let t=!1;const n=s.default(e.passWord);return this.objects.forEach((i=>{if(i.userName===e.userName&&i.passWord===n)return t=!0})),t}existUserName(e){let t=!1;return this.objects.forEach((n=>{if(n.userName===e)return t=!0})),t}setUserInstances(e,t){const n=this.getInstance(e);t.forEach((e=>{if(!e.serviceUuid||!e.instanceUuid)throw new Error("Type error, The instances of user must is IUserHaveInstance array.")})),n.instances=[],t.forEach((e=>{n.instances.push({instanceUuid:String(e.instanceUuid),serviceUuid:String(e.serviceUuid)})}))}getUserByUserName(e){for(const t of this.objects){const n=t[1];if(n.userName===e)return n}return null}getInstance(e){return this.objects.get(e)}setInstance(e,t){this.objects.set(e,t)}hasInstance(e){return this.objects.has(e)}deleteInstance(e){this.hasInstance(e)&&(this.objects.delete(e),a.default.delete("User",e))}getQueryWrapper(){return new d.QueryWrapper(new d.LocalFileSource(this.objects))}}},9951:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const s=n(1088),r=n(1153),u=i(n(4447)),o=i(n(525));class a{constructor(e,t){this.maxSize=e,this.arr=new Array;for(let n=0;n<e;n++)this.arr.push(t)}push(e){this.arr.length<this.maxSize||this.arr.shift(),this.arr.push(e)}getArray(){return this.arr}}t.default=new class{constructor(){this.countMap=new Map,this.systemChart=new a(60,{cpu:0,mem:0}),this.statusChart=new a(60,{value:0,totalInstance:0,runningInstance:0}),this.requestCount=0,setInterval((()=>{const e=r.systemInfo();e?this.systemChart.push({cpu:Number((100*e.cpuUsage).toFixed(1)),mem:Number((100*e.memUsage).toFixed(1))}):this.systemChart.push({cpu:0,mem:0})}),1e4),setInterval((async()=>{const e=new Array;for(const t of u.default.services.entries())try{e.push(await new o.default(t[1]).request("info/overview"))}catch(e){}let t=0,n=0;for(const i of e)i.instance&&(t+=i.instance.total,n+=i.instance.running);this.statusChart.push({value:this.requestCount,totalInstance:t,runningInstance:n}),this.requestCount=0}),1e4)}addRequestCount(){this.requestCount++}getSystemChartArray(){return this.systemChart.getArray()}getStatusChartArray(){return this.statusChart.getArray()}emitCountEvent(e){const t=this.countMap.get(e);t?this.countMap.set(e,t+1):this.countMap.set(e,1)}eventCount(e){return this.countMap.get(e)}emitLogEvent(e,t){const n=(new Date).toLocaleString();s.logger.info(`The object [${t}] triggered the [${e}] event at ${n}`)}}},1653:function(e,t,n){var i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.systemConfig=t.saveSystemConfig=t.initSystemConfig=void 0;const s=i(n(8415)),r=i(n(4789));let u=null;t.systemConfig=u,t.initSystemConfig=function(){t.systemConfig=u=r.default.load("SystemConfig",s.default,"config"),u||(t.systemConfig=u=new s.default,r.default.store("SystemConfig","config",u))},t.saveSystemConfig=function(e){r.default.store("SystemConfig","config",e)}},2866:function(e,t,n){var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return s(t,e),t},u=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.getVersion=t.initVersionManager=void 0;const o=r(n(4470)),a=u(n(606)),d=n(1088),l="package.json";t.initVersionManager=function(){try{if(a.default.set("version","Unknown"),o.existsSync(l)){const e=JSON.parse(o.readFileSync(l,{encoding:"utf-8"}));e.version&&a.default.set("version",e.version)}}catch(e){d.logger.error("版本检查失败",e)}},t.getVersion=function(){return a.default.get("version","Unknown")}},1511:e=>{e.exports=require("@koa/router")},4470:e=>{e.exports=require("fs-extra")},1406:e=>{e.exports=require("koa")},5004:e=>{e.exports=require("koa-body")},9511:e=>{e.exports=require("koa-session")},8097:e=>{e.exports=require("koa-static")},8094:e=>{e.exports=require("log4js")},1490:e=>{e.exports=require("md5")},7411:e=>{e.exports=require("os-utils")},8087:e=>{e.exports=require("socket.io-client")},5828:e=>{e.exports=require("uuid")},3685:e=>{e.exports=require("http")},2037:e=>{e.exports=require("os")},1017:e=>{e.exports=require("path")},2781:e=>{e.exports=require("stream")}},t={};!function n(i){var s=t[i];if(void 0!==s)return s.exports;var r=t[i]={exports:{}};return e[i].call(r.exports,r,r.exports,n),r.exports}(6672)})();